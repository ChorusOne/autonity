package test

import (
	"crypto/ecdsa"
	"fmt"
	"github.com/autonity/autonity/common"
	"github.com/autonity/autonity/core"
	"github.com/autonity/autonity/core/types"
	"github.com/autonity/autonity/crypto"
	"github.com/autonity/autonity/p2p/enode"
	"github.com/autonity/autonity/params"
	"github.com/stretchr/testify/require"
	"math/big"
	"reflect"
	"testing"
	"time"
)

const (
	treasuryFee             = 100
	minBaseFee              = 10
	delegationRate          = 1
	epochPeriod             = 5
	unBondingPeriod         = 5
	maxCommitteeSize        = 7
	blockPeriod             = 1
	defaultVersion          = "v0.0.0"
	contractUpgradeBytecode = "60806040523480156200001157600080fd5b506002601e6000600e60018154811062000030576200002f62000375565b5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060040154620000a59190620003dd565b601e6000600e600181548110620000c157620000c062000375565b5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600401819055506040518060400160405280600581526020017f322e302e30000000000000000000000000000000000000000000000000000000815250600460080190805190602001906200017d92919062000239565b506103e8601d6000600460000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550600080620001f89190620002ca565b6001600062000208919062000310565b6002600062000218919062000310565b6000600360006101000a81548160ff0219169083151502179055506200047a565b828054620002479062000444565b90600052602060002090601f0160209004810192826200026b5760008555620002b7565b82601f106200028657805160ff1916838001178555620002b7565b82800160010185558215620002b7579182015b82811115620002b657825182559160200191906001019062000299565b5b509050620002c6919062000356565b5090565b508054620002d89062000444565b6000825580601f10620002ec57506200030d565b601f0160209004906000526020600020908101906200030c919062000356565b5b50565b5080546200031e9062000444565b6000825580601f1062000332575062000353565b601f01602090049060005260206000209081019062000352919062000356565b5b50565b5b808211156200037157600081600090555060010162000357565b5090565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b6000819050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b6000620003ea82620003a4565b9150620003f783620003a4565b9250826200040a5762000409620003ae565b5b828204905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b600060028204905060018216806200045d57607f821691505b6020821081141562000474576200047362000415565b5b50919050565b618f4f806200048a6000396000f3fe608060405260043610620003135760003560e01c8063872cf0591162000199578063ae1f5fa011620000f1578063cb696f5411620000a3578063d886f8a21162000079578063d886f8a21462000c0e578063dd62ed3e1462000c3c578063e485c6fb1462000c80578063e7f43c681462000cc4576200031b565b8063cb696f541462000b96578063cf9c57191462000bc4578063d5f394881462000bde576200031b565b8063ae1f5fa01462000a8d578063b2ea9adb1462000aa7578063b66b3e791462000ad5578063b7ab4db51462000b06578063c2362dd51462000b36578063c9d97af41462000b66576200031b565b8063a416aa06116200014b578063a416aa06146200095f578063a515366a146200098d578063a5d059ca14620009bb578063a8b2216e14620009e9578063a9059cbb1462000a19578063ab8f6ffe1462000a5d576200031b565b8063872cf05914620008595780638bac7dad146200087357806395d89b4114620008a15780639bb851c014620008d15780639c98e47114620009015780639dc29fac1462000931576200031b565b806344697221116200026b5780636b5f444c116200021d57806377e741c711620001f357806377e741c71462000792578063787a243314620007c057806379502c5514620007f0578063819b64631462000829576200031b565b80636b5f444c14620006f057806370a08231146200071e578063731b3a031462000762576200031b565b80634469722114620005aa5780634b0dff6314620005da578063520fdbbc146200060a57806355230e9314620006385780635f7d3949146200067c578063662cd7f414620006c0576200031b565b80631604e41611620002c55780631604e416146200046457806318160ddd14620004945780631904bb2e14620004c457806323b872dd14620005085780633ac25ba8146200054c57806340c10f19146200057c576200031b565b806305261aea146200031d57806306fdde031462000362578063095ea7b314620003925780630d8e6e2c14620003d6578063112206331462000406578063114eaf551462000436576200031b565b366200031b57005b005b3480156200032a57600080fd5b5062000349600480360381019062000343919062005543565b62000cf4565b60405162000359929190620056d8565b60405180910390f35b3480156200036f57600080fd5b506200037a62000ee6565b604051620003899190620057b0565b60405180910390f35b3480156200039f57600080fd5b50620003be6004803603810190620003b8919062005805565b62000f23565b604051620003cd91906200584c565b60405180910390f35b348015620003e357600080fd5b50620003ee62000f3c565b604051620003fd9190620057b0565b60405180910390f35b3480156200041357600080fd5b506200041e62000fd9565b6040516200042d91906200587a565b60405180910390f35b3480156200044357600080fd5b506200046260048036038101906200045c919062005543565b62000fe6565b005b3480156200047157600080fd5b506200047c62001089565b6040516200048b91906200587a565b60405180910390f35b348015620004a157600080fd5b50620004ac6200108f565b604051620004bb91906200587a565b60405180910390f35b348015620004d157600080fd5b50620004f06004803603810190620004ea919062005897565b62001099565b604051620004ff919062005b30565b60405180910390f35b3480156200051557600080fd5b506200053460048036038101906200052e919062005b54565b6200130e565b6040516200054391906200584c565b60405180910390f35b3480156200055957600080fd5b5062000564620013c4565b6040516200057391906200587a565b60405180910390f35b3480156200058957600080fd5b50620005a86004803603810190620005a2919062005805565b620013df565b005b348015620005b757600080fd5b50620005c262001574565b604051620005d191906200587a565b60405180910390f35b348015620005e757600080fd5b50620005f26200157a565b6040516200060191906200587a565b60405180910390f35b3480156200061757600080fd5b5062000636600480360381019062000630919062005897565b62001580565b005b3480156200064557600080fd5b506200066460048036038101906200065e919062005bb0565b6200165d565b60405162000673919062005d11565b60405180910390f35b3480156200068957600080fd5b50620006a86004803603810190620006a2919062005bb0565b62001811565b604051620006b7919062005d46565b60405180910390f35b348015620006cd57600080fd5b50620006d862001a24565b604051620006e791906200587a565b60405180910390f35b348015620006fd57600080fd5b506200071c600480360381019062000716919062005543565b62001a2a565b005b3480156200072b57600080fd5b506200074a600480360381019062000744919062005897565b62001acd565b6040516200075991906200587a565b60405180910390f35b3480156200076f57600080fd5b506200077a62001b16565b6040516200078991906200587a565b60405180910390f35b3480156200079f57600080fd5b50620007be6004803603810190620007b8919062005543565b62001b20565b005b348015620007cd57600080fd5b50620007d862001bc3565b604051620007e791906200587a565b60405180910390f35b348015620007fd57600080fd5b506200080862001bc9565b604051620008209a9998979695949392919062005d74565b60405180910390f35b3480156200083657600080fd5b506200084162001cdb565b6040516200085091906200587a565b60405180910390f35b3480156200086657600080fd5b506200087162001ce8565b005b3480156200088057600080fd5b506200089f600480360381019062000899919062005543565b62001d9b565b005b348015620008ae57600080fd5b50620008b962001e84565b604051620008c89190620057b0565b60405180910390f35b348015620008de57600080fd5b50620008e962001ec1565b604051620008f891906200587a565b60405180910390f35b3480156200090e57600080fd5b506200091962001ec7565b6040516200092891906200587a565b60405180910390f35b3480156200093e57600080fd5b506200095d600480360381019062000957919062005805565b62001ecd565b005b3480156200096c57600080fd5b506200098b600480360381019062000985919062005f7c565b6200209a565b005b3480156200099a57600080fd5b50620009b96004803603810190620009b3919062005805565b620021a2565b005b348015620009c857600080fd5b50620009e76004803603810190620009e1919062005805565b62002345565b005b348015620009f657600080fd5b5062000a01620024e8565b60405162000a1091906200609d565b60405180910390f35b34801562000a2657600080fd5b5062000a45600480360381019062000a3f919062005805565b620025cb565b60405162000a5491906200584c565b60405180910390f35b34801562000a6a57600080fd5b5062000a75620025e4565b60405162000a849190620060c1565b60405180910390f35b34801562000a9a57600080fd5b5062000aa5620026a5565b005b34801562000ab457600080fd5b5062000ad3600480360381019062000acd919062006199565b620030a8565b005b34801562000ae257600080fd5b5062000aed6200315c565b60405162000afd9291906200627b565b60405180910390f35b34801562000b1357600080fd5b5062000b1e62003293565b60405162000b2d919062006373565b60405180910390f35b34801562000b4357600080fd5b5062000b4e62003323565b60405162000b5d91906200587a565b60405180910390f35b34801562000b7357600080fd5b5062000b7e62003329565b60405162000b8d91906200587a565b60405180910390f35b34801562000ba357600080fd5b5062000bc2600480360381019062000bbc919062005543565b6200332f565b005b34801562000bd157600080fd5b5062000bdc6200340b565b005b34801562000beb57600080fd5b5062000bf6620034d2565b60405162000c05919062005d46565b60405180910390f35b34801562000c1b57600080fd5b5062000c3a600480360381019062000c349190620063c8565b620034f8565b005b34801562000c4957600080fd5b5062000c68600480360381019062000c629190620063fa565b620035d5565b60405162000c7791906200587a565b60405180910390f35b34801562000c8d57600080fd5b5062000cac600480360381019062000ca6919062005bb0565b6200365c565b60405162000cbb919062005d11565b60405180910390f35b34801562000cd157600080fd5b5062000cdc62003810565b60405162000ceb919062005d46565b60405180910390f35b600060603373ffffffffffffffffffffffffffffffffffffffff16602060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161462000d8b576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040162000d8290620064b7565b60405180910390fd5b826014600082825462000d9f919062006508565b925050819055504360046005015460105462000dbc919062006508565b141562000e105762000dd06014546200383d565b600060148190555062000de262003b21565b62000dec620026a5565b436010819055506001600f600082825462000e08919062006508565b925050819055505b600360009054906101000a900460ff16601280805480602002602001604051908101604052809291908181526020016000905b8282101562000ed757838290600052602060002090600202016040518060400160405290816000820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020016001820154815250508152602001906001019062000e43565b50505050905091509150915091565b60606040518060400160405280600681526020017f4e6577746f6e0000000000000000000000000000000000000000000000000000815250905090565b600062000f3233848462003bf2565b6001905092915050565b60606004600801805462000f509062006594565b80601f016020809104026020016040519081016040528092919081815260200182805462000f7e9062006594565b801562000fcf5780601f1062000fa35761010080835404028352916020019162000fcf565b820191906000526020600020905b81548152906001019060200180831162000fb157829003601f168201915b5050505050905090565b6000600460030154905090565b3373ffffffffffffffffffffffffffffffffffffffff16600460000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16146200107c576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040162001073906200661a565b60405180910390fd5b8060046006018190555050565b60145481565b6000601f54905090565b620010a3620051ca565b601e60008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020604051806101600160405290816000820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020016001820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001600282018054620011ac9062006594565b80601f0160208091040260200160405190810160405280929190818152602001828054620011da9062006594565b80156200122b5780601f10620011ff576101008083540402835291602001916200122b565b820191906000526020600020905b8154815290600101906020018083116200120d57829003601f168201915b50505050508152602001600382015481526020016004820154815260200160058201548152602001600682015481526020016007820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020016008820154815260200160098201548152602001600a820160009054906101000a900460ff166002811115620012ee57620012ed620059ab565b5b6002811115620013035762001302620059ab565b5b815250509050919050565b60006200131d84848462003dc5565b600082601660008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054620013a991906200663c565b9050620013b885338362003bf2565b60019150509392505050565b60006004600701546002620013da919062006677565b905090565b3373ffffffffffffffffffffffffffffffffffffffff16600460000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161462001475576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016200146c906200661a565b60405180910390fd5b6710000000000000008110620014c2576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401620014b9906200674e565b60405180910390fd5b80601d60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825462001513919062006508565b9250508190555080601f60008282546200152e919062006508565b925050819055507f48490b4407bb949b708ec5f514b4167f08f4969baaf78d53b05028adf369bfcf82826040516200156892919062006770565b60405180910390a15050565b60195481565b601c5481565b3373ffffffffffffffffffffffffffffffffffffffff16600460000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161462001616576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016200160d906200661a565b60405180910390fd5b80600460000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b6060600083836200166f91906200663c565b67ffffffffffffffff8111156200168b576200168a62005e35565b5b604051908082528060200260200182016040528015620016c857816020015b620016b46200527b565b815260200190600190039081620016aa5790505b50905060005b8484620016dc91906200663c565b8110156200180657601a60008287620016f6919062006508565b81526020019081526020016000206040518060800160405290816000820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020016001820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200160028201548152602001600382015481525050828281518110620017e557620017e46200679d565b5b60200260200101819052508080620017fd90620067cc565b915050620016ce565b508091505092915050565b6000806000905060005b60128054905081101562001877576012818154811062001840576200183f6200679d565b5b906000526020600020906002020160010154826200185f919062006508565b915080806200186e90620067cc565b9150506200181b565b506000811415620018bf576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401620018b6906200686a565b60405180910390fd5b60008385620018cf919062006508565b9050600081604051602001620018e69190620068b1565b6040516020818303038152906040528051906020012060001c905060008382620019119190620068fd565b90506000805b601280549050811015620019e057601281815481106200193c576200193b6200679d565b5b906000526020600020906002020160010154826200195b919062006508565b91506001826200196c91906200663c565b8311620019ca57601281815481106200198a57620019896200679d565b5b906000526020600020906002020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16965050505050505062001a1e565b8080620019d790620067cc565b91505062001917565b506040517f08c379a000000000000000000000000000000000000000000000000000000000815260040162001a1590620069ab565b60405180910390fd5b92915050565b601b5481565b3373ffffffffffffffffffffffffffffffffffffffff16600460000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161462001ac0576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040162001ab7906200661a565b60405180910390fd5b8060046005018190555050565b6000601d60008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b6000601054905090565b3373ffffffffffffffffffffffffffffffffffffffff16600460000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161462001bb6576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040162001bad906200661a565b60405180910390fd5b8060046002018190555050565b60185481565b60048060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16908060010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff169080600201549080600301549080600401549080600501549080600601549080600701549080600801805462001c4c9062006594565b80601f016020809104026020016040519081016040528092919081815260200182805462001c7a9062006594565b801562001ccb5780601f1062001c9f5761010080835404028352916020019162001ccb565b820191906000526020600020905b81548152906001019060200180831162001cad57829003601f168201915b505050505090806009015490508a565b6000600460070154905090565b3373ffffffffffffffffffffffffffffffffffffffff16600460000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161462001d7e576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040162001d75906200661a565b60405180910390fd5b6001600360006101000a81548160ff021916908315150217905550565b3373ffffffffffffffffffffffffffffffffffffffff16600460000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161462001e31576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040162001e28906200661a565b60405180910390fd5b6000811162001e77576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040162001e6e9062006a1d565b60405180910390fd5b8060046007018190555050565b60606040518060400160405280600381526020017f4e544e0000000000000000000000000000000000000000000000000000000000815250905090565b60135481565b60115481565b3373ffffffffffffffffffffffffffffffffffffffff16600460000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161462001f63576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040162001f5a906200661a565b60405180910390fd5b80601d60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054101562001fe8576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040162001fdf9062006a8f565b60405180910390fd5b80601d60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282546200203991906200663c565b9250508190555080601f60008282546200205491906200663c565b925050819055507f5024dbeedf0c06664c9bd7be836915730c955e936972c020683dadf11d5488a382826040516200208e92919062006770565b60405180910390a15050565b60006040518061016001604052803373ffffffffffffffffffffffffffffffffffffffff168152602001600073ffffffffffffffffffffffffffffffffffffffff16815260200183815260200160048001548152602001600081526020016000815260200160008152602001600073ffffffffffffffffffffffffffffffffffffffff1681526020016000815260200143815260200160006002811115620021475762002146620059ab565b5b8152509050620021578162003f8f565b7f6921859367aca5023ddf910758cd0cda74261b2e5c8425c253e9d03b62b950b8338260200151848460e0015160405162002196949392919062006ab1565b60405180910390a15050565b8173ffffffffffffffffffffffffffffffffffffffff16601e60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161462002275576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016200226c9062006b55565b60405180910390fd5b600060028111156200228c576200228b620059ab565b5b601e60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600a0160009054906101000a900460ff166002811115620022f157620022f0620059ab565b5b1462002334576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016200232b9062006bc7565b60405180910390fd5b6200234182823362004418565b5050565b8173ffffffffffffffffffffffffffffffffffffffff16601e60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161462002418576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016200240f9062006b55565b60405180910390fd5b600060028111156200242f576200242e620059ab565b5b601e60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600a0160009054906101000a900460ff166002811115620024945762002493620059ab565b5b14620024d7576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401620024ce9062006bc7565b60405180910390fd5b620024e482823362004667565b5050565b60606015805480602002602001604051908101604052809291908181526020016000905b82821015620025c25783829060005260206000200180546200252e9062006594565b80601f01602080910402602001604051908101604052809291908181526020018280546200255c9062006594565b8015620025ad5780601f106200258157610100808354040283529160200191620025ad565b820191906000526020600020905b8154815290600101906020018083116200258f57829003601f168201915b5050505050815260200190600101906200250c565b50505050905090565b6000620025da33848462003dc5565b6001905092915050565b60606012805480602002602001604051908101604052809291908181526020016000905b828210156200269c57838290600052602060002090600202016040518060400160405290816000820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020016001820154815250508152602001906001019062002608565b50505050905090565b3373ffffffffffffffffffffffffffffffffffffffff16602060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161462002738576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016200272f90620064b7565b60405180910390fd5b6000600e805490501162002783576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016200277a9062006c39565b60405180910390fd5b6000805b600e80549050811015620029105760006002811115620027ac57620027ab620059ab565b5b601e6000600e8481548110620027c757620027c66200679d565b5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600a0160009054906101000a900460ff166002811115620028525762002851620059ab565b5b148015620028e357506000601e6000600e84815481106200287857620028776200679d565b5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060040154115b15620028fa578180620028f690620067cc565b9250505b80806200290790620067cc565b91505062002787565b506000600460070154905081811062002927578190505b60008267ffffffffffffffff81111562002946576200294562005e35565b5b6040519080825280602002602001820160405280156200298357816020015b6200296f620051ca565b815260200190600190039081620029655790505b50905060008267ffffffffffffffff811115620029a557620029a462005e35565b5b604051908082528060200260200182016040528015620029e257816020015b620029ce620051ca565b815260200190600190039081620029c45790505b5090506000805b600e8054905081101562002e3e576000600281111562002a0e5762002a0d620059ab565b5b601e6000600e848154811062002a295762002a286200679d565b5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600a0160009054906101000a900460ff16600281111562002ab45762002ab3620059ab565b5b14801562002b4557506000601e6000600e848154811062002ada5762002ad96200679d565b5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060040154115b1562002e28576000601e6000600e848154811062002b685762002b676200679d565b5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020604051806101600160405290816000820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020016001820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200160028201805462002c979062006594565b80601f016020809104026020016040519081016040528092919081815260200182805462002cc59062006594565b801562002d165780601f1062002cea5761010080835404028352916020019162002d16565b820191906000526020600020905b81548152906001019060200180831162002cf857829003601f168201915b50505050508152602001600382015481526020016004820154815260200160058201548152602001600682015481526020016007820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020016008820154815260200160098201548152602001600a820160009054906101000a900460ff16600281111562002dd95762002dd8620059ab565b5b600281111562002dee5762002ded620059ab565b5b8152505090508085848151811062002e0b5762002e0a6200679d565b5b6020026020010181905250828062002e2390620067cc565b935050505b808062002e3590620067cc565b915050620029e9565b506004600701548351111562002ec65762002e598362004992565b60005b60046007015481101562002ebf5783818151811062002e805762002e7f6200679d565b5b602002602001015183828151811062002e9e5762002e9d6200679d565b5b6020026020010181905250808062002eb690620067cc565b91505062002e5c565b5062002eca565b8291505b6012600062002eda9190620052cf565b6015600062002eea9190620052f5565b600060118190555060005b84811015620030a0576000604051806040016040528085848151811062002f215762002f206200679d565b5b60200260200101516020015173ffffffffffffffffffffffffffffffffffffffff16815260200185848151811062002f5e5762002f5d6200679d565b5b6020026020010151608001518152509050601281908060018154018082558091505060019003906000526020600020906002020160009091909190915060008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060208201518160010155505060158483815181106200300657620030056200679d565b5b6020026020010151604001519080600181540180825580915050600190039060005260206000200160009091909190915090805190602001906200304c92919062005318565b508382815181106200306357620030626200679d565b5b6020026020010151608001516011600082825462003082919062006508565b925050819055505080806200309790620067cc565b91505062002ef5565b505050505050565b3373ffffffffffffffffffffffffffffffffffffffff16600460000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16146200313e576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040162003135906200661a565b60405180910390fd5b6200314b600083620049b2565b62003158600182620049b2565b5050565b60608060006001818054620031719062006594565b80601f01602080910402602001604051908101604052809291908181526020018280546200319f9062006594565b8015620031f05780601f10620031c457610100808354040283529160200191620031f0565b820191906000526020600020905b815481529060010190602001808311620031d257829003601f168201915b50505050509150808054620032059062006594565b80601f0160208091040260200160405190810160405280929190818152602001828054620032339062006594565b8015620032845780601f10620032585761010080835404028352916020019162003284565b820191906000526020600020905b8154815290600101906020018083116200326657829003601f168201915b50505050509050915091509091565b6060600e8054806020026020016040519081016040528092919081815260200182805480156200331957602002820191906000526020600020905b8160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019060010190808311620032ce575b5050505050905090565b60105481565b600f5481565b3373ffffffffffffffffffffffffffffffffffffffff16600460000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614620033c5576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401620033bc906200661a565b60405180910390fd5b806004600301819055507f1f4d2fc7529047a5bd96d3229bfea127fd18b7748f13586e097c69fccd389128816040516200340091906200587a565b60405180910390a150565b3373ffffffffffffffffffffffffffffffffffffffff16600460000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614620034a1576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040162003498906200661a565b60405180910390fd5b600080620034b09190620053a9565b60016000620034c09190620053ef565b60026000620034d09190620053ef565b565b602060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b3373ffffffffffffffffffffffffffffffffffffffff16600460000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16146200358e576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040162003585906200661a565b60405180910390fd5b80600460010160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b6000601660008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905092915050565b6060600083836200366e91906200663c565b67ffffffffffffffff8111156200368a576200368962005e35565b5b604051908082528060200260200182016040528015620036c757816020015b620036b36200527b565b815260200190600190039081620036a95790505b50905060005b8484620036db91906200663c565b8110156200380557601760008287620036f5919062006508565b81526020019081526020016000206040518060800160405290816000820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020016001820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200160028201548152602001600382015481525050828281518110620037e457620037e36200679d565b5b60200260200101819052508080620037fc90620067cc565b915050620036cd565b508091505092915050565b6000600460000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b8047101562003883576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016200387a9062006cd1565b60405180910390fd5b6000670de0b6b3a764000082600460020154620038a1919062006677565b620038ad919062006cf3565b905060008111156200393757600460010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc829081150290604051600060405180830381858888f1935050505015801562003925573d6000803e3d6000fd5b5080826200393491906200663c565b91505b81601360008282546200394b919062006508565b9250508190555060005b60128054905081101562003b1c576000601e60006012848154811062003980576200397f6200679d565b5b906000526020600020906002020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000209050600060115485836004015462003a05919062006677565b62003a11919062006cf3565b9050600081111562003aa5578160070160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663fb489a7b826040518263ffffffff1660e01b81526004016000604051808303818588803b15801562003a8a57600080fd5b505af115801562003a9f573d6000803e3d6000fd5b50505050505b7fb3b7a071186534c03b40695710096f289fd4ed6c1a374aff0bb648955e4fe5638260010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff168260405162003afc92919062006770565b60405180910390a15050808062003b1390620067cc565b91505062003955565b505050565b600060185490505b60195481101562003b555762003b3f8162004b2d565b808062003b4c90620067cc565b91505062003b29565b506019546018819055506000601b5490506000601b5490505b601c5481101562003be75743600460060154601a60008481526020019081526020016000206003015462003ba3919062006508565b1162003bcb5762003bb48162004d8d565b60018262003bc3919062006508565b915062003bd1565b62003be7565b808062003bde90620067cc565b91505062003b6e565b5080601b8190555050565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff16141562003c65576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040162003c5c9062006da1565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff16141562003cd8576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040162003ccf9062006e39565b60405180910390fd5b80601660008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b9258360405162003db891906200587a565b60405180910390a3505050565b80601d60008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054101562003e4a576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040162003e419062006eab565b60405180910390fd5b80601d60008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825462003e9b91906200663c565b9250508190555080601f600082825462003eb6919062006508565b9250508190555080600262003ecc919062006677565b601d60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825462003f1c919062006508565b925050819055508173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef8360405162003f8291906200587a565b60405180910390a3505050565b600062003fa0826040015162004f91565b836020018193508273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152505050600081146200401f576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401620040169062006f1d565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff16601e6000846020015173ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614620040f7576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401620040ee9062006f8f565b60405180910390fd5b633b9aca008260600151111562004145576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016200413c9062007001565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168260e0015173ffffffffffffffffffffffffffffffffffffffff16141562004200578160200151826000015183606001516040516200419c9062005435565b620041aa9392919062007023565b604051809103906000f080158015620041c7573d6000803e3d6000fd5b508260e0019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff16815250505b600e82602001519080600181540180825580915050600190039060005260206000200160009091909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555081601e6000846020015173ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060208201518160010160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060408201518160020190805190602001906200435792919062005318565b50606082015181600301556080820151816004015560a0820151816005015560c0820151816006015560e08201518160070160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506101008201518160080155610120820151816009015561014082015181600a0160006101000a81548160ff021916908360028111156200440c576200440b620059ab565b5b02179055509050505050565b600082116200445e576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016200445590620070d6565b60405180910390fd5b81601d60008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020541015620044e3576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401620044da9062007148565b60405180910390fd5b81601d60008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282546200453491906200663c565b92505081905550600060405180608001604052808373ffffffffffffffffffffffffffffffffffffffff1681526020018573ffffffffffffffffffffffffffffffffffffffff1681526020018481526020014381525090508060176000601954815260200190815260200160002060008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060208201518160010160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506040820151816002015560608201518160030155905050601960008154809291906200465c90620067cc565b919050555050505050565b6000601e60008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060070160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166370a08231836040518263ffffffff1660e01b81526004016200470691906200718f565b602060405180830381865afa15801562004724573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906200474a9190620071c3565b90508281101562004792576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040162004789906200726b565b60405180910390fd5b601e60008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060070160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16639dc29fac83856040518363ffffffff1660e01b8152600401620048319291906200728d565b600060405180830381600087803b1580156200484c57600080fd5b505af115801562004861573d6000803e3d6000fd5b50505050600060405180608001604052808473ffffffffffffffffffffffffffffffffffffffff1681526020018673ffffffffffffffffffffffffffffffffffffffff16815260200185815260200143815250905080601a6000601c54815260200190815260200160002060008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060208201518160010160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506040820151816002015560608201518160030155905050601c60008154809291906200498690620067cc565b91905055505050505050565b620049af81600060018451620049a991906200663c565b62004ff2565b50565b81546002600180831615610100020382160482518082016020811060208410016002811462004a68576001811462004a8e578660005260208404602060002001600160028402018855602085066020850681602003808a01878b016001836101000a038083511687540187556001870196506020830192505b8183101562004a4a578251875560018701965060208301925062004a2b565b8183036101000a905080818451040287555050505050505062004b24565b60028302826020036101000a846020036101000a60208901510402018501875562004b24565b8660005260208404602060002001600160028402018855846020038088018589016001836101000a03808351167fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff008b160185556020830192506001850194505b8183101562004b0d578251855560018501945060208301925062004aee565b8183036101000a9050808184510402855550505050505b50505050505050565b60006017600083815260200190815260200160002090506000601e60008360010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002090506000808260040154141562004bc7578260020154905062004bf1565b81600401548360020154836008015462004be2919062006677565b62004bee919062006cf3565b90505b8160070160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166340c10f198460000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16836040518363ffffffff1660e01b815260040162004c769291906200728d565b600060405180830381600087803b15801562004c9157600080fd5b505af115801562004ca6573d6000803e3d6000fd5b50505050826002015482600401600082825462004cc4919062006508565b925050819055508160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168360000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16141562004d6a57826002015482600501600082825462004d62919062006508565b925050819055505b8082600801600082825462004d80919062006508565b9250508190555050505050565b6000601a600083815260200190815260200160002090506000601e60008360010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000209050600081600801548260040154846002015462004e28919062006677565b62004e34919062006cf3565b90508082600401600082825462004e4c91906200663c565b925050819055508160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168360000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16141562004eee578082600501600082825462004ee691906200663c565b925050819055505b826002015482600801600082825462004f0891906200663c565b9250508190555080601d60008560000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825462004f84919062006508565b9250508190555050505050565b60008062004f9e62005443565b600060408286516020880160ff5afa62004fb757600080fd5b6c010000000000000000000000008251049050808260016002811062004fe25762004fe16200679d565b5b6020020151935093505050915091565b60008290506000829050808214156200500d575050620051c5565b60008560028686620050209190620072c4565b6200502c919062007362565b86620050399190620073d6565b815181106200504d576200504c6200679d565b5b60200260200101516080015190505b81831362005193575b808684815181106200507c576200507b6200679d565b5b6020026020010151608001511115620050a55782806200509c9062007474565b93505062005065565b5b858281518110620050bc57620050bb6200679d565b5b602002602001015160800151811115620050e6578180620050dd90620074c2565b925050620050a6565b8183136200518d578582815181106200510457620051036200679d565b5b60200260200101518684815181106200512257620051216200679d565b5b602002602001015187858151811062005140576200513f6200679d565b5b602002602001018885815181106200515d576200515c6200679d565b5b6020026020010182905282905250508280620051799062007474565b93505081806200518990620074c2565b9250505b6200505c565b81851215620051aa57620051a986868462004ff2565b5b83831215620051c157620051c086848662004ff2565b5b5050505b505050565b604051806101600160405280600073ffffffffffffffffffffffffffffffffffffffff168152602001600073ffffffffffffffffffffffffffffffffffffffff1681526020016060815260200160008152602001600081526020016000815260200160008152602001600073ffffffffffffffffffffffffffffffffffffffff168152602001600081526020016000815260200160006002811115620052755762005274620059ab565b5b81525090565b6040518060800160405280600073ffffffffffffffffffffffffffffffffffffffff168152602001600073ffffffffffffffffffffffffffffffffffffffff16815260200160008152602001600081525090565b5080546000825560020290600052602060002090810190620052f2919062005465565b50565b5080546000825590600052602060002090810190620053159190620054ad565b50565b828054620053269062006594565b90600052602060002090601f0160209004810192826200534a576000855562005396565b82601f106200536557805160ff191683800117855562005396565b8280016001018555821562005396579182015b828111156200539557825182559160200191906001019062005378565b5b509050620053a59190620054d5565b5090565b508054620053b79062006594565b6000825580601f10620053cb5750620053ec565b601f016020900490600052602060002090810190620053eb9190620054d5565b5b50565b508054620053fd9062006594565b6000825580601f1062005411575062005432565b601f016020900490600052602060002090810190620054319190620054d5565b5b50565b611a09806200751183390190565b6040518060400160405280600290602082028036833780820191505090505090565b5b80821115620054a957600080820160006101000a81549073ffffffffffffffffffffffffffffffffffffffff021916905560018201600090555060020162005466565b5090565b5b80821115620054d15760008181620054c79190620053ef565b50600101620054ae565b5090565b5b80821115620054f0576000816000905550600101620054d6565b5090565b6000604051905090565b600080fd5b600080fd5b6000819050919050565b6200551d8162005508565b81146200552957600080fd5b50565b6000813590506200553d8162005512565b92915050565b6000602082840312156200555c576200555b620054fe565b5b60006200556c848285016200552c565b91505092915050565b60008115159050919050565b6200558c8162005575565b82525050565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000620055eb82620055be565b9050919050565b620055fd81620055de565b82525050565b6200560e8162005508565b82525050565b6040820160008201516200562c6000850182620055f2565b50602082015162005641602085018262005603565b50505050565b600062005655838362005614565b60408301905092915050565b6000602082019050919050565b60006200567b8262005592565b6200568781856200559d565b93506200569483620055ae565b8060005b83811015620056cb578151620056af888262005647565b9750620056bc8362005661565b92505060018101905062005698565b5085935050505092915050565b6000604082019050620056ef600083018562005581565b81810360208301526200570381846200566e565b90509392505050565b600081519050919050565b600082825260208201905092915050565b60005b83811015620057485780820151818401526020810190506200572b565b8381111562005758576000848401525b50505050565b6000601f19601f8301169050919050565b60006200577c826200570c565b62005788818562005717565b93506200579a81856020860162005728565b620057a5816200575e565b840191505092915050565b60006020820190508181036000830152620057cc81846200576f565b905092915050565b620057df81620055de565b8114620057eb57600080fd5b50565b600081359050620057ff81620057d4565b92915050565b600080604083850312156200581f576200581e620054fe565b5b60006200582f85828601620057ee565b925050602062005842858286016200552c565b9150509250929050565b600060208201905062005863600083018462005581565b92915050565b620058748162005508565b82525050565b600060208201905062005891600083018462005869565b92915050565b600060208284031215620058b057620058af620054fe565b5b6000620058c084828501620057ee565b91505092915050565b6000620058d682620055be565b9050919050565b620058e881620058c9565b82525050565b600082825260208201905092915050565b60006200590c826200570c565b620059188185620058ee565b93506200592a81856020860162005728565b62005935816200575e565b840191505092915050565b6000819050919050565b60006200596b620059656200595f84620055be565b62005940565b620055be565b9050919050565b60006200597f826200594a565b9050919050565b6000620059938262005972565b9050919050565b620059a58162005986565b82525050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602160045260246000fd5b60038110620059ee57620059ed620059ab565b5b50565b600081905062005a0182620059da565b919050565b600062005a1382620059f1565b9050919050565b62005a258162005a06565b82525050565b60006101608301600083015162005a466000860182620058dd565b50602083015162005a5b6020860182620055f2565b506040830151848203604086015262005a758282620058ff565b915050606083015162005a8c606086018262005603565b50608083015162005aa1608086018262005603565b5060a083015162005ab660a086018262005603565b5060c083015162005acb60c086018262005603565b5060e083015162005ae060e08601826200599a565b5061010083015162005af761010086018262005603565b5061012083015162005b0e61012086018262005603565b5061014083015162005b2561014086018262005a1a565b508091505092915050565b6000602082019050818103600083015262005b4c818462005a2b565b905092915050565b60008060006060848603121562005b705762005b6f620054fe565b5b600062005b8086828701620057ee565b935050602062005b9386828701620057ee565b925050604062005ba6868287016200552c565b9150509250925092565b6000806040838503121562005bca5762005bc9620054fe565b5b600062005bda858286016200552c565b925050602062005bed858286016200552c565b9150509250929050565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b60808201600082015162005c3b6000850182620058dd565b50602082015162005c506020850182620055f2565b50604082015162005c65604085018262005603565b50606082015162005c7a606085018262005603565b50505050565b600062005c8e838362005c23565b60808301905092915050565b6000602082019050919050565b600062005cb48262005bf7565b62005cc0818562005c02565b935062005ccd8362005c13565b8060005b8381101562005d0457815162005ce8888262005c80565b975062005cf58362005c9a565b92505060018101905062005cd1565b5085935050505092915050565b6000602082019050818103600083015262005d2d818462005ca7565b905092915050565b62005d4081620055de565b82525050565b600060208201905062005d5d600083018462005d35565b92915050565b62005d6e81620058c9565b82525050565b60006101408201905062005d8c600083018d62005d35565b62005d9b602083018c62005d63565b62005daa604083018b62005869565b62005db9606083018a62005869565b62005dc8608083018962005869565b62005dd760a083018862005869565b62005de660c083018762005869565b62005df560e083018662005869565b81810361010083015262005e0a81856200576f565b905062005e1c61012083018462005869565b9b9a5050505050505050505050565b600080fd5b600080fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b62005e6f826200575e565b810181811067ffffffffffffffff8211171562005e915762005e9062005e35565b5b80604052505050565b600062005ea6620054f4565b905062005eb4828262005e64565b919050565b600067ffffffffffffffff82111562005ed75762005ed662005e35565b5b62005ee2826200575e565b9050602081019050919050565b82818337600083830152505050565b600062005f1562005f0f8462005eb9565b62005e9a565b90508281526020810184848401111562005f345762005f3362005e30565b5b62005f4184828562005eef565b509392505050565b600082601f83011262005f615762005f6062005e2b565b5b813562005f7384826020860162005efe565b91505092915050565b60006020828403121562005f955762005f94620054fe565b5b600082013567ffffffffffffffff81111562005fb65762005fb562005503565b5b62005fc48482850162005f49565b91505092915050565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b6000620060078383620058ff565b905092915050565b6000602082019050919050565b6000620060298262005fcd565b62006035818562005fd8565b935083602082028501620060498562005fe9565b8060005b858110156200608b578484038952815162006069858262005ff9565b945062006076836200600f565b925060208a019950506001810190506200604d565b50829750879550505050505092915050565b60006020820190508181036000830152620060b981846200601c565b905092915050565b60006020820190508181036000830152620060dd81846200566e565b905092915050565b600067ffffffffffffffff82111562006103576200610262005e35565b5b6200610e826200575e565b9050602081019050919050565b6000620061326200612c84620060e5565b62005e9a565b90508281526020810184848401111562006151576200615062005e30565b5b6200615e84828562005eef565b509392505050565b600082601f8301126200617e576200617d62005e2b565b5b8135620061908482602086016200611b565b91505092915050565b60008060408385031215620061b357620061b2620054fe565b5b600083013567ffffffffffffffff811115620061d457620061d362005503565b5b620061e28582860162006166565b925050602083013567ffffffffffffffff81111562006206576200620562005503565b5b620062148582860162005f49565b9150509250929050565b600081519050919050565b600082825260208201905092915050565b600062006247826200621e565b62006253818562006229565b93506200626581856020860162005728565b62006270816200575e565b840191505092915050565b600060408201905081810360008301526200629781856200623a565b90508181036020830152620062ad81846200576f565b90509392505050565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b6000620062f08383620055f2565b60208301905092915050565b6000602082019050919050565b60006200631682620062b6565b620063228185620062c1565b93506200632f83620062d2565b8060005b83811015620063665781516200634a8882620062e2565b97506200635783620062fc565b92505060018101905062006333565b5085935050505092915050565b600060208201905081810360008301526200638f818462006309565b905092915050565b620063a281620058c9565b8114620063ae57600080fd5b50565b600081359050620063c28162006397565b92915050565b600060208284031215620063e157620063e0620054fe565b5b6000620063f184828501620063b1565b91505092915050565b60008060408385031215620064145762006413620054fe565b5b60006200642485828601620057ee565b92505060206200643785828601620057ee565b9150509250929050565b7f66756e6374696f6e207265737472696374656420746f207468652070726f746f60008201527f636f6c0000000000000000000000000000000000000000000000000000000000602082015250565b60006200649f60238362005717565b9150620064ac8262006441565b604082019050919050565b60006020820190508181036000830152620064d28162006490565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000620065158262005508565b9150620065228362005508565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff038211156200655a5762006559620064d9565b5b828201905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b60006002820490506001821680620065ad57607f821691505b60208210811415620065c457620065c362006565565b5b50919050565b7f63616c6c6572206973206e6f7420746865206f70657261746f72000000000000600082015250565b600062006602601a8362005717565b91506200660f82620065ca565b602082019050919050565b600060208201905081810360008301526200663581620065f3565b9050919050565b6000620066498262005508565b9150620066568362005508565b9250828210156200666c576200666b620064d9565b5b828203905092915050565b6000620066848262005508565b9150620066918362005508565b9250817fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0483118215151615620066cd57620066cc620064d9565b5b828202905092915050565b7f697373756564204e6577746f6e2063616e27742062652067726561746572207460008201527f68616e20325e3630000000000000000000000000000000000000000000000000602082015250565b60006200673660288362005717565b91506200674382620066d8565b604082019050919050565b60006020820190508181036000830152620067698162006727565b9050919050565b600060408201905062006787600083018562005d35565b62006796602083018462005869565b9392505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b6000620067d98262005508565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8214156200680f576200680e620064d9565b5b600182019050919050565b7f54686520636f6d6d6974746565206973206e6f74207374616b696e6700000000600082015250565b600062006852601c8362005717565b91506200685f826200681a565b602082019050919050565b60006020820190508181036000830152620068858162006843565b9050919050565b6000819050919050565b620068ab620068a58262005508565b6200688c565b82525050565b6000620068bf828462006896565b60208201915081905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b60006200690a8262005508565b9150620069178362005508565b9250826200692a5762006929620068ce565b5b828206905092915050565b7f5468657265206973206e6f2076616c696461746f72206c65667420696e20746860008201527f65206e6574776f726b0000000000000000000000000000000000000000000000602082015250565b60006200699360298362005717565b9150620069a08262006935565b604082019050919050565b60006020820190508181036000830152620069c68162006984565b9050919050565b7f636f6d6d69747465652073697a652063616e2774206265203000000000000000600082015250565b600062006a0560198362005717565b915062006a1282620069cd565b602082019050919050565b6000602082019050818103600083015262006a3881620069f6565b9050919050565b7f416d6f756e7420657863656564732062616c616e636500000000000000000000600082015250565b600062006a7760168362005717565b915062006a848262006a3f565b602082019050919050565b6000602082019050818103600083015262006aaa8162006a68565b9050919050565b600060808201905062006ac8600083018762005d35565b62006ad7602083018662005d35565b818103604083015262006aeb81856200576f565b905062006afc606083018462005d35565b95945050505050565b7f76616c696461746f72206e6f7420726567697374657265640000000000000000600082015250565b600062006b3d60188362005717565b915062006b4a8262006b05565b602082019050919050565b6000602082019050818103600083015262006b708162006b2e565b9050919050565b7f76616c696461746f72206e65656420746f20626520656e61626c656400000000600082015250565b600062006baf601c8362005717565b915062006bbc8262006b77565b602082019050919050565b6000602082019050818103600083015262006be28162006ba0565b9050919050565b7f5468657265206d7573742062652076616c696461746f72730000000000000000600082015250565b600062006c2160188362005717565b915062006c2e8262006be9565b602082019050919050565b6000602082019050818103600083015262006c548162006c12565b9050919050565b7f6e6f7420656e6f7567682066756e647320746f20706572666f726d207265646960008201527f73747269627574696f6e00000000000000000000000000000000000000000000602082015250565b600062006cb9602a8362005717565b915062006cc68262006c5b565b604082019050919050565b6000602082019050818103600083015262006cec8162006caa565b9050919050565b600062006d008262005508565b915062006d0d8362005508565b92508262006d205762006d1f620068ce565b5b828204905092915050565b7f45524332303a20617070726f76652066726f6d20746865207a65726f2061646460008201527f7265737300000000000000000000000000000000000000000000000000000000602082015250565b600062006d8960248362005717565b915062006d968262006d2b565b604082019050919050565b6000602082019050818103600083015262006dbc8162006d7a565b9050919050565b7f45524332303a20617070726f766520746f20746865207a65726f20616464726560008201527f7373000000000000000000000000000000000000000000000000000000000000602082015250565b600062006e2160228362005717565b915062006e2e8262006dc3565b604082019050919050565b6000602082019050818103600083015262006e548162006e12565b9050919050565b7f616d6f756e7420657863656564732062616c616e636500000000000000000000600082015250565b600062006e9360168362005717565b915062006ea08262006e5b565b602082019050919050565b6000602082019050818103600083015262006ec68162006e84565b9050919050565b7f656e6f6465206572726f72000000000000000000000000000000000000000000600082015250565b600062006f05600b8362005717565b915062006f128262006ecd565b602082019050919050565b6000602082019050818103600083015262006f388162006ef6565b9050919050565b7f76616c696461746f7220616c7265616479207265676973746572656400000000600082015250565b600062006f77601c8362005717565b915062006f848262006f3f565b602082019050919050565b6000602082019050818103600083015262006faa8162006f68565b9050919050565b7f696e76616c696420636f6d6d697373696f6e2072617465000000000000000000600082015250565b600062006fe960178362005717565b915062006ff68262006fb1565b602082019050919050565b600060208201905081810360008301526200701c8162006fda565b9050919050565b60006060820190506200703a600083018662005d35565b62007049602083018562005d63565b62007058604083018462005869565b949350505050565b7f616d6f756e74206e65656420746f206265207374726963746c7920706f73697460008201527f6976650000000000000000000000000000000000000000000000000000000000602082015250565b6000620070be60238362005717565b9150620070cb8262007060565b604082019050919050565b60006020820190508181036000830152620070f181620070af565b9050919050565b7f696e73756666696369656e74204e6577746f6e2062616c616e63650000000000600082015250565b600062007130601b8362005717565b91506200713d82620070f8565b602082019050919050565b60006020820190508181036000830152620071638162007121565b9050919050565b6000620071778262005972565b9050919050565b62007189816200716a565b82525050565b6000602082019050620071a660008301846200717e565b92915050565b600081519050620071bd8162005512565b92915050565b600060208284031215620071dc57620071db620054fe565b5b6000620071ec84828501620071ac565b91505092915050565b7f696e73756666696369656e74204c6971756964204e6577746f6e2062616c616e60008201527f6365000000000000000000000000000000000000000000000000000000000000602082015250565b60006200725360228362005717565b91506200726082620071f5565b604082019050919050565b60006020820190508181036000830152620072868162007244565b9050919050565b6000604082019050620072a4600083018562005d63565b620072b3602083018462005869565b9392505050565b6000819050919050565b6000620072d182620072ba565b9150620072de83620072ba565b9250827f8000000000000000000000000000000000000000000000000000000000000000018212600084121516156200731c576200731b620064d9565b5b827f7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff018213600084121615620073575762007356620064d9565b5b828203905092915050565b60006200736f82620072ba565b91506200737c83620072ba565b9250826200738f576200738e620068ce565b5b600160000383147f800000000000000000000000000000000000000000000000000000000000000083141615620073cb57620073ca620064d9565b5b828205905092915050565b6000620073e382620072ba565b9150620073f083620072ba565b9250817f7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff038313600083121516156200742e576200742d620064d9565b5b817f8000000000000000000000000000000000000000000000000000000000000000038312600083121615620074695762007468620064d9565b5b828201905092915050565b60006200748182620072ba565b91507f7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff821415620074b757620074b6620064d9565b5b600182019050919050565b6000620074cf82620072ba565b91507f8000000000000000000000000000000000000000000000000000000000000000821415620075055762007504620064d9565b5b60018203905091905056fe60806040523480156200001157600080fd5b5060405162001a0938038062001a098339818101604052810190620000379190620001f3565b82600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555081600260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555080600481905550336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505050506200024f565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006200013b826200010e565b9050919050565b6200014d816200012e565b81146200015957600080fd5b50565b6000815190506200016d8162000142565b92915050565b600062000180826200010e565b9050919050565b620001928162000173565b81146200019e57600080fd5b50565b600081519050620001b28162000187565b92915050565b6000819050919050565b620001cd81620001b8565b8114620001d957600080fd5b50565b600081519050620001ed81620001c2565b92915050565b6000806000606084860312156200020f576200020e62000109565b5b60006200021f868287016200015c565b93505060206200023286828701620001a1565b92505060406200024586828701620001dc565b9150509250925092565b6117aa806200025f6000396000f3fe6080604052600436106100915760003560e01c806370a082311161005957806370a082311461018f5780639dc29fac146101cc578063a9059cbb146101f5578063dd62ed3e14610232578063fb489a7b1461026f57610091565b8063047fc9aa14610096578063095ea7b3146100c157806318160ddd146100fe57806323b872dd1461012957806340c10f1914610166575b600080fd5b3480156100a257600080fd5b506100ab610279565b6040516100b89190610ff1565b60405180910390f35b3480156100cd57600080fd5b506100e860048036038101906100e3919061109b565b61027f565b6040516100f591906110f6565b60405180910390f35b34801561010a57600080fd5b50610113610296565b6040516101209190610ff1565b60405180910390f35b34801561013557600080fd5b50610150600480360381019061014b9190611111565b6102a0565b60405161015d91906110f6565b60405180910390f35b34801561017257600080fd5b5061018d600480360381019061018891906111a2565b610350565b005b34801561019b57600080fd5b506101b660048036038101906101b191906111e2565b6105c9565b6040516101c39190610ff1565b60405180910390f35b3480156101d857600080fd5b506101f360048036038101906101ee91906111a2565b610615565b005b34801561020157600080fd5b5061021c6004803603810190610217919061109b565b6107f3565b60405161022991906110f6565b60405180910390f35b34801561023e57600080fd5b506102596004803603810190610254919061120f565b61080a565b6040516102669190610ff1565b60405180910390f35b610277610891565b005b60035481565b600061028c338484610abc565b6001905092915050565b6000600354905090565b60006102ad848484610c87565b600082600760008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054610337919061127e565b9050610344853383610abc565b60019150509392505050565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16146103de576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016103d590611335565b60405180910390fd5b60008111610421576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610418906113a1565b60405180910390fd5b6000600660008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600001541415610553576005829080600181540180825580915050600190039060005260206000200160009091909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550600060405180604001604052806000815260200160016005805490506104f5919061127e565b815250905080600660008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000820151816000015560208201518160010155905050505b80600660008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160008282546105a591906113c1565b9250508190555080600360008282546105be91906113c1565b925050819055505050565b6000600660008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600001549050919050565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16146106a3576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161069a90611335565b60405180910390fd5b80600660008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600001541015610728576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161071f90611463565b60405180910390fd5b80600660008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600001600082825461077a919061127e565b925050819055508060036000828254610793919061127e565b925050819055506000600660008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000015414156107ef576107ee82610e28565b5b5050565b6000610800338484610c87565b6001905092915050565b6000600760008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905092915050565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161461091f576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161091690611335565b60405180910390fd5b60003490506000612710600454836109379190611483565b610941919061150c565b9050600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc829081150290604051600060405180830381858888f193505050501580156109ab573d6000803e3d6000fd5b5080826109b8919061127e565b915060005b600580549050811015610ab7576000600582815481106109e0576109df61153d565b5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1690506000600354600660008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000015486610a609190611483565b610a6a919061150c565b90508173ffffffffffffffffffffffffffffffffffffffff166108fc829081150290604051600060405180830381858888f193505050505050508080610aaf9061156c565b9150506109bd565b505050565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff161415610b2c576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610b2390611627565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff161415610b9c576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610b93906116b9565b60405180910390fd5b80600760008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92583604051610c7a9190610ff1565b60405180910390a3505050565b80600660008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600001541015610d0c576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610d0390611725565b60405180910390fd5b80600660008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000016000828254610d5e919061127e565b9250508190555080600660008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000016000828254610db791906113c1565b925050819055508173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef83604051610e1b9190610ff1565b60405180910390a3505050565b6000600660008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020604051806040016040529081600082015481526020016001820154815250509050600081602001519050600060056001600580549050610ea9919061127e565b81548110610eba57610eb961153d565b5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1690508060058381548110610efc57610efb61153d565b5b9060005260206000200160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555081600660008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600101819055506005805480610f9d57610f9c611745565b5b6001900381819060005260206000200160006101000a81549073ffffffffffffffffffffffffffffffffffffffff0219169055905550505050565b6000819050919050565b610feb81610fd8565b82525050565b60006020820190506110066000830184610fe2565b92915050565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b600061103c82611011565b9050919050565b61104c81611031565b811461105757600080fd5b50565b60008135905061106981611043565b92915050565b61107881610fd8565b811461108357600080fd5b50565b6000813590506110958161106f565b92915050565b600080604083850312156110b2576110b161100c565b5b60006110c08582860161105a565b92505060206110d185828601611086565b9150509250929050565b60008115159050919050565b6110f0816110db565b82525050565b600060208201905061110b60008301846110e7565b92915050565b60008060006060848603121561112a5761112961100c565b5b60006111388682870161105a565b93505060206111498682870161105a565b925050604061115a86828701611086565b9150509250925092565b600061116f82611011565b9050919050565b61117f81611164565b811461118a57600080fd5b50565b60008135905061119c81611176565b92915050565b600080604083850312156111b9576111b861100c565b5b60006111c78582860161118d565b92505060206111d885828601611086565b9150509250929050565b6000602082840312156111f8576111f761100c565b5b60006112068482850161105a565b91505092915050565b600080604083850312156112265761122561100c565b5b60006112348582860161105a565b92505060206112458582860161105a565b9150509250929050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b600061128982610fd8565b915061129483610fd8565b9250828210156112a7576112a661124f565b5b828203905092915050565b600082825260208201905092915050565b7f43616c6c207265737472696374656420746f20746865204175746f6e6974792060008201527f436f6e7472616374000000000000000000000000000000000000000000000000602082015250565b600061131f6028836112b2565b915061132a826112c3565b604082019050919050565b6000602082019050818103600083015261134e81611312565b9050919050565b7f616d6f756e74206d757374206265207374726963746c7920706f736974697665600082015250565b600061138b6020836112b2565b915061139682611355565b602082019050919050565b600060208201905081810360008301526113ba8161137e565b9050919050565b60006113cc82610fd8565b91506113d783610fd8565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0382111561140c5761140b61124f565b5b828201905092915050565b7f616464726573732062616c616e6365206e6f742073756666696369656e740000600082015250565b600061144d601e836112b2565b915061145882611417565b602082019050919050565b6000602082019050818103600083015261147c81611440565b9050919050565b600061148e82610fd8565b915061149983610fd8565b9250817fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff04831182151516156114d2576114d161124f565b5b828202905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b600061151782610fd8565b915061152283610fd8565b925082611532576115316114dd565b5b828204905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b600061157782610fd8565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8214156115aa576115a961124f565b5b600182019050919050565b7f45524332303a20617070726f76652066726f6d20746865207a65726f2061646460008201527f7265737300000000000000000000000000000000000000000000000000000000602082015250565b60006116116024836112b2565b915061161c826115b5565b604082019050919050565b6000602082019050818103600083015261164081611604565b9050919050565b7f45524332303a20617070726f766520746f20746865207a65726f20616464726560008201527f7373000000000000000000000000000000000000000000000000000000000000602082015250565b60006116a36022836112b2565b91506116ae82611647565b604082019050919050565b600060208201905081810360008301526116d281611696565b9050919050565b7f616d6f756e7420657863656564732062616c616e636500000000000000000000600082015250565b600061170f6016836112b2565b915061171a826116d9565b602082019050919050565b6000602082019050818103600083015261173e81611702565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603160045260246000fdfea26469706673582212202e71af90117f7972ec06c8150db4e119d66c4d4563e3dca4285f089d51cb24d064736f6c634300080a0033a2646970667358221220520120348586a5b8e18a4a3d65bd6a743416b545fb7267ad22201019367175ea64736f6c634300080a0033"
	contractUpgradeABI      = `[{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"addr","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"BurnedStake","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"gasPrice","type":"uint256"}],"name":"MinimumBaseFeeUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"addr","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"MintedStake","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"treasury","type":"address"},{"indexed":false,"internalType":"address","name":"addr","type":"address"},{"indexed":false,"internalType":"string","name":"enode","type":"string"},{"indexed":false,"internalType":"address","name":"liquidContract","type":"address"}],"name":"RegisteredValidator","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"addr","type":"address"}],"name":"RemovedValidator","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"addr","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"Rewarded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"stateMutability":"payable","type":"fallback"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_addr","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_validator","type":"address"},{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"bond","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_addr","type":"address"},{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"burn","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"completeContractUpgrade","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"computeCommittee","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"config","outputs":[{"internalType":"address","name":"operatorAccount","type":"address"},{"internalType":"address payable","name":"treasuryAccount","type":"address"},{"internalType":"uint256","name":"treasuryFee","type":"uint256"},{"internalType":"uint256","name":"minBaseFee","type":"uint256"},{"internalType":"uint256","name":"delegationRate","type":"uint256"},{"internalType":"uint256","name":"epochPeriod","type":"uint256"},{"internalType":"uint256","name":"unbondingPeriod","type":"uint256"},{"internalType":"uint256","name":"committeeSize","type":"uint256"},{"internalType":"string","name":"contractVersion","type":"string"},{"internalType":"uint256","name":"blockPeriod","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"deployer","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"epochID","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"epochReward","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"epochTotalBondedStake","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"finalize","outputs":[{"internalType":"bool","name":"","type":"bool"},{"components":[{"internalType":"address","name":"addr","type":"address"},{"internalType":"uint256","name":"votingPower","type":"uint256"}],"internalType":"struct Autonity.CommitteeMember[]","name":"","type":"tuple[]"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"startId","type":"uint256"},{"internalType":"uint256","name":"lastId","type":"uint256"}],"name":"getBondingReq","outputs":[{"components":[{"internalType":"address payable","name":"delegator","type":"address"},{"internalType":"address","name":"delegatee","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"startBlock","type":"uint256"}],"internalType":"struct Autonity.Staking[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getCommittee","outputs":[{"components":[{"internalType":"address","name":"addr","type":"address"},{"internalType":"uint256","name":"votingPower","type":"uint256"}],"internalType":"struct Autonity.CommitteeMember[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getCommitteeEnodes","outputs":[{"internalType":"string[]","name":"","type":"string[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getDoubleMaxCommitteeSize","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getLastEpochBlock","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getMaxCommitteeSize","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getMinimumBaseFee","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getNewContract","outputs":[{"internalType":"bytes","name":"","type":"bytes"},{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getOperator","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"height","type":"uint256"},{"internalType":"uint256","name":"round","type":"uint256"}],"name":"getProposer","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"startId","type":"uint256"},{"internalType":"uint256","name":"lastId","type":"uint256"}],"name":"getUnbondingReq","outputs":[{"components":[{"internalType":"address payable","name":"delegator","type":"address"},{"internalType":"address","name":"delegatee","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"startBlock","type":"uint256"}],"internalType":"struct Autonity.Staking[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_addr","type":"address"}],"name":"getValidator","outputs":[{"components":[{"internalType":"address payable","name":"treasury","type":"address"},{"internalType":"address","name":"addr","type":"address"},{"internalType":"string","name":"enode","type":"string"},{"internalType":"uint256","name":"commissionRate","type":"uint256"},{"internalType":"uint256","name":"bondedStake","type":"uint256"},{"internalType":"uint256","name":"selfBondedStake","type":"uint256"},{"internalType":"uint256","name":"totalSlashed","type":"uint256"},{"internalType":"contract Liquid","name":"liquidContract","type":"address"},{"internalType":"uint256","name":"liquidSupply","type":"uint256"},{"internalType":"uint256","name":"registrationBlock","type":"uint256"},{"internalType":"enum Autonity.ValidatorState","name":"state","type":"uint8"}],"internalType":"struct Autonity.Validator","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getValidators","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getVersion","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"headBondingID","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"headUnbondingID","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"lastEpochBlock","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_addr","type":"address"},{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"mint","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"pure","type":"function"},{"inputs":[{"internalType":"string","name":"_enode","type":"string"}],"name":"registerValidator","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"resetContractUpgrade","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_size","type":"uint256"}],"name":"setCommitteeSize","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_period","type":"uint256"}],"name":"setEpochPeriod","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_price","type":"uint256"}],"name":"setMinimumBaseFee","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_account","type":"address"}],"name":"setOperatorAccount","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address payable","name":"_account","type":"address"}],"name":"setTreasuryAccount","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_treasuryFee","type":"uint256"}],"name":"setTreasuryFee","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_period","type":"uint256"}],"name":"setUnbondingPeriod","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"pure","type":"function"},{"inputs":[],"name":"tailBondingID","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"tailUnbondingID","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalRedistributed","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_recipient","type":"address"},{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"sender","type":"address"},{"internalType":"address","name":"recipient","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_validator","type":"address"},{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"unbond","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes","name":"_bytecode","type":"bytes"},{"internalType":"string","name":"_abi","type":"string"}],"name":"upgradeContract","outputs":[],"stateMutability":"nonpayable","type":"function"},{"stateMutability":"payable","type":"receive"}]`
)

var (
	// new settings to be submitted for protocol in testcase.
	newMinBaseFee      = new(big.Int).SetUint64(20)
	newCommitteeSize   = new(big.Int).SetUint64(10)
	newUnBondingPeriod = new(big.Int).SetUint64(30)
	newEpochPeriod     = new(big.Int).SetUint64(45)
	newTreasuryFee     = new(big.Int).SetUint64(10)
	mintAmount         = new(big.Int).SetUint64(100)
	burnAmount         = new(big.Int).SetUint64(50)
)

// test registerValidator, unRegisterValidators, bond and unbond operations.
func TestACPublicWritters(t *testing.T) {
	numOfValidators := 2

	operator, err := makeAccount()
	require.NoError(t, err)
	operatorAddr := crypto.PubkeyToAddress(operator.PublicKey)

	newValidator, err := makeAccount()
	require.NoError(t, err)
	newValidatorAddr := crypto.PubkeyToAddress(newValidator.PublicKey)
	enodeUrl := enode.V4DNSUrl(newValidator.PublicKey, "127.0.0.1", 30303, 30303) + ":30303"

	// newton to be mint
	amount := new(big.Int).SetUint64(10)

	cases := []*testCase{
		{
			name:          "Test register new validator",
			numValidators: numOfValidators,
			numBlocks:     10,
			txPerPeer:     1,
			// register validator right after block #5 is committed from client V0.
			afterHooks: map[string]hook{
				"V0": registerValidatorHook(map[uint64]struct{}{
					5: {},
				},
					enodeUrl,
				),
			},
			finalAssert: func(t *testing.T, validators map[string]*testNode) {
				client := interact(validators["V0"].rpcPort)
				defer client.close()
				val, err := client.call(validators["V0"].lastBlock).getValidator(newValidatorAddr)
				require.NoError(t, err)
				require.Equal(t, newValidatorAddr, val.Addr)
			},
		},
		{
			name:          "bond stake to validator",
			numValidators: numOfValidators,
			numBlocks:     10,
			txPerPeer:     1,
			genesisHook: func(g *core.Genesis) *core.Genesis {
				g.Config.AutonityContractConfig.Operator = operatorAddr
				// pre-mine Auton for system operator and new validator.
				g.Alloc[operatorAddr] = core.GenesisAccount{
					Balance: new(big.Int).Exp(big.NewInt(2), big.NewInt(128), nil),
				}
				g.Alloc[newValidatorAddr] = core.GenesisAccount{
					Balance: new(big.Int).Exp(big.NewInt(2), big.NewInt(128), nil),
				}
				return g
			},
			// mint newton for new validator right after block #3 via client V0.
			// bond newton to validator right after block #7 via client V1.
			afterHooks: map[string]hook{
				"V0": mintStakeHook(map[uint64]struct{}{
					2: {},
				},
					operator,
					newValidator,
					amount,
				),
				"V1": bondStakeHook(map[uint64]struct{}{
					7: {},
				},
					newValidator,
					amount,
				),
			},
			finalAssert: func(t *testing.T, validators map[string]*testNode) {
				node := validators["V1"]
				client := interact(node.rpcPort)
				defer client.close()
				reqs, err := client.call(node.lastBlock).getBondingReq(new(big.Int).SetUint64(0),
					new(big.Int).SetUint64(3))
				require.NoError(t, err)
				require.Equal(t, node.EthAddress(), reqs[2].Delegatee)
				require.Equal(t, newValidatorAddr, reqs[2].Delegator)
				require.Equal(t, amount, reqs[2].Amount)
			},
		},
		{
			name:          "unbond stake from validator",
			numValidators: numOfValidators,
			numBlocks:     10,
			txPerPeer:     1,
			afterHooks: map[string]hook{
				"V0": unBondStakeHook(map[uint64]struct{}{
					2: {},
				},
					amount,
				),
			},
			finalAssert: func(t *testing.T, validators map[string]*testNode) {
				node := validators["V0"]
				client := interact(node.rpcPort)
				defer client.close()
				reqs, err := client.call(node.lastBlock).getUnBondingReq(new(big.Int).SetUint64(0),
					new(big.Int).SetUint64(1))
				require.NoError(t, err)
				require.Equal(t, node.EthAddress(), reqs[0].Delegatee)
				require.Equal(t, node.EthAddress(), reqs[0].Delegator)
				require.Equal(t, amount, reqs[0].Amount)
			},
		},
	}

	for _, testcase := range cases {
		runTest(t, testcase)
	}
}

// test system settings management by operator account.
func TestACSystemOperatorOPs(t *testing.T) {
	numOfValidators := 3
	initialOperator, err := makeAccount()
	require.NoError(t, err)
	initialOperatorAddr := crypto.PubkeyToAddress(initialOperator.PublicKey)

	newOperator, err := makeAccount()
	require.NoError(t, err)
	newOperatorAddr := crypto.PubkeyToAddress(newOperator.PublicKey)

	testCase := &testCase{
		name:          "Test AC system operator change settings",
		numValidators: numOfValidators,
		numBlocks:     20,
		txPerPeer:     1,
		// set AC configs in genesis hook.
		genesisHook: func(g *core.Genesis) *core.Genesis {
			g.Config.AutonityContractConfig.Operator = initialOperatorAddr
			g.Alloc[initialOperatorAddr] = core.GenesisAccount{
				Balance: new(big.Int).Exp(big.NewInt(2), big.NewInt(128), nil),
			}
			g.Alloc[newOperatorAddr] = core.GenesisAccount{
				Balance: new(big.Int).Exp(big.NewInt(2), big.NewInt(128), nil),
			}
			setACConfig(g.Config.AutonityContractConfig)
			return g
		},
		afterHooks: map[string]hook{
			// change settings right after block #1 is committed from client V0.
			"V0": changeSettingHook(
				map[uint64]struct{}{
					1: {},
				},
				initialOperator,
				newOperatorAddr,
			),
			// burn stake right after block #5 from client V1.
			"V1": burnStakeHook(
				map[uint64]struct{}{
					5: {},
				},
				initialOperator,
				newOperatorAddr,
			),
			// change operator after block #10 from client V3.
			"V2": setOperatorHook(
				map[uint64]struct{}{
					10: {},
				},
				initialOperator,
				newOperatorAddr,
			),
		},
		finalAssert: func(t *testing.T, validators map[string]*testNode) {
			node := validators["V0"]
			client := interact(node.rpcPort)
			defer client.close()
			mBaseFee, err := client.call(node.lastBlock).getMinBaseFee()
			require.NoError(t, err)
			require.Equal(t, newMinBaseFee.Uint64(), mBaseFee.Uint64())
			comSize, err := client.call(node.lastBlock).getMaxCommitteeSize()
			require.NoError(t, err)
			require.Equal(t, newCommitteeSize.Uint64(), comSize.Uint64())
			newOP, err := client.call(node.lastBlock).getOperator()
			require.NoError(t, err)
			require.Equal(t, newOperatorAddr, newOP)
			balance, err := client.call(node.lastBlock).balanceOf(newOperatorAddr)
			require.NoError(t, err)
			require.Equal(t, mintAmount.Sub(mintAmount, burnAmount).Uint64(), balance.Uint64())
		},
	}
	runTest(t, testCase)
}

// test system settings / state getters
func TestACStateGetters(t *testing.T) {
	operatorKey, err := makeAccount()
	require.NoError(t, err)
	operatorAddress := crypto.PubkeyToAddress(operatorKey.PublicKey)
	numOfValidators := 2
	testCase := &testCase{
		name:          "Test AC state getters",
		numValidators: numOfValidators,
		numBlocks:     10,
		txPerPeer:     1,
		// set AC configs in genesis hook.
		genesisHook: func(g *core.Genesis) *core.Genesis {
			g.Config.AutonityContractConfig.Operator = operatorAddress
			g.Config.AutonityContractConfig.Treasury = operatorAddress
			setACConfig(g.Config.AutonityContractConfig)
			return g
		},
		// start AC state getter verifications right after block #5 is committed from client V0.
		afterHooks: map[string]hook{
			"V0": acStateGettersHook(map[uint64]struct{}{
				5: {},
			},
				operatorAddress,
				numOfValidators,
			),
		},
	}
	runTest(t, testCase)
}

func burnStakeHook(upgradeBlocks map[uint64]struct{}, op *ecdsa.PrivateKey, ac common.Address) hook {
	return func(block *types.Block, validator *testNode, tCase *testCase, currentTime time.Time) error {
		blockNum := block.Number().Uint64()
		if _, ok := upgradeBlocks[blockNum]; !ok {
			return nil
		}
		interaction := interact(validator.rpcPort)
		defer interaction.close()
		if _, err := interaction.tx(op).burn(ac, burnAmount); err != nil {
			return err
		}
		return nil
	}
}

func setOperatorHook(upgradeBlocks map[uint64]struct{}, operator *ecdsa.PrivateKey, opAddr common.Address) hook {
	return func(block *types.Block, validator *testNode, tCase *testCase, currentTime time.Time) error {
		blockNum := block.Number().Uint64()
		if _, ok := upgradeBlocks[blockNum]; !ok {
			return nil
		}
		interaction := interact(validator.rpcPort)
		defer interaction.close()
		if _, err := interaction.tx(operator).setOperator(opAddr); err != nil {
			return err
		}
		return nil
	}
}

func changeSettingHook(upgradeBlocks map[uint64]struct{}, opKey *ecdsa.PrivateKey, newOpAddr common.Address) hook {
	return func(block *types.Block, validator *testNode, tCase *testCase, currentTime time.Time) error {
		blockNum := block.Number().Uint64()
		if _, ok := upgradeBlocks[blockNum]; !ok {
			return nil
		}
		interaction := interact(validator.rpcPort)
		defer interaction.close()
		if _, err := interaction.tx(opKey).setMinBaseFee(newMinBaseFee); err != nil {
			return err
		}
		if _, err := interaction.tx(opKey).setCommitteeSize(newCommitteeSize); err != nil {
			return err
		}
		if _, err := interaction.tx(opKey).setUnBondingPeriod(newUnBondingPeriod); err != nil {
			return err
		}
		if _, err := interaction.tx(opKey).setEpochPeriod(newEpochPeriod); err != nil {
			return err
		}
		if _, err := interaction.tx(opKey).setTreasuryAccount(newOpAddr); err != nil {
			return err
		}
		if _, err := interaction.tx(opKey).setTreasuryFee(newTreasuryFee); err != nil {
			return err
		}
		if _, err := interaction.tx(opKey).mint(newOpAddr, mintAmount); err != nil {
			return err
		}
		return nil
	}
}

func unBondStakeHook(upgradeBlocks map[uint64]struct{}, amount *big.Int) hook {
	return func(block *types.Block, validator *testNode, tCase *testCase, currentTime time.Time) error {
		blockNum := block.Number().Uint64()
		if _, ok := upgradeBlocks[blockNum]; !ok {
			return nil
		}
		interaction := interact(validator.rpcPort)
		defer interaction.close()
		if _, err := interaction.tx(validator.privateKey).unbond(validator.EthAddress(), amount); err != nil {
			return err
		}
		return nil
	}
}

func bondStakeHook(upgradeBlocks map[uint64]struct{}, newVal *ecdsa.PrivateKey, amount *big.Int) hook {
	return func(block *types.Block, validator *testNode, tCase *testCase, currentTime time.Time) error {
		blockNum := block.Number().Uint64()
		if _, ok := upgradeBlocks[blockNum]; !ok {
			return nil
		}
		interaction := interact(validator.rpcPort)
		defer interaction.close()
		if _, err := interaction.tx(newVal).bond(validator.EthAddress(), amount); err != nil {
			return err
		}
		return nil
	}
}

func mintStakeHook(upgradeBlocks map[uint64]struct{}, operator *ecdsa.PrivateKey, newVal *ecdsa.PrivateKey, amount *big.Int) hook {
	return func(block *types.Block, validator *testNode, tCase *testCase, currentTime time.Time) error {
		blockNum := block.Number().Uint64()
		if _, ok := upgradeBlocks[blockNum]; !ok {
			return nil
		}
		interaction := interact(validator.rpcPort)
		defer interaction.close()
		newValAddr := crypto.PubkeyToAddress(newVal.PublicKey)
		if _, err := interaction.tx(operator).mint(newValAddr, amount); err != nil {
			return err
		}
		return nil
	}
}

func registerValidatorHook(upgradeBlocks map[uint64]struct{}, enode string) hook {
	return func(block *types.Block, validator *testNode, tCase *testCase, currentTime time.Time) error {
		blockNum := block.Number().Uint64()
		if _, ok := upgradeBlocks[blockNum]; !ok {
			return nil
		}
		interaction := interact(validator.rpcPort)
		defer interaction.close()
		if _, err := interaction.tx(validator.privateKey).registerValidator(enode); err != nil {
			return err
		}
		return nil
	}
}

func acStateGettersHook(upgradeBlocks map[uint64]struct{}, operator common.Address, numVals int) hook {
	return func(block *types.Block, validator *testNode, tCase *testCase, currentTime time.Time) error {
		blockNum := block.Number().Uint64()
		if _, ok := upgradeBlocks[blockNum]; !ok {
			return nil
		}
		interaction := interact(validator.rpcPort)
		defer interaction.close()

		if err := checkVersion(interaction, blockNum, defaultVersion); err != nil {
			return err
		}

		if err := checkCommittee(interaction, blockNum, numVals); err != nil {
			return err
		}

		if err := checkValidators(interaction, blockNum, numVals); err != nil {
			return err
		}

		if err := checkValidator(interaction, blockNum, validator.EthAddress(), validator.netNode.url); err != nil {
			return err
		}

		if err := checkMaxCommitteeSize(interaction, blockNum, maxCommitteeSize); err != nil {
			return err
		}

		if err := checkCommitteeEnodes(interaction, blockNum, numVals); err != nil {
			return err
		}

		if err := checkMinBaseFee(interaction, blockNum, minBaseFee); err != nil {
			return err
		}

		if err := checkOperatorAddress(interaction, blockNum, operator); err != nil {
			return err
		}

		if err := checkNewContract(interaction, blockNum, []uint8{}, ""); err != nil {
			return err
		}

		start := new(big.Int).SetUint64(0)
		end := new(big.Int).SetUint64(uint64(numVals))
		if err := checkBondingReqs(interaction, blockNum, start, end, numVals); err != nil {
			return err
		}
		if err := checkUnBondingReqs(interaction, blockNum, start, end, numVals); err != nil {
			return err
		}
		return nil
	}
}

func checkVersion(client *interactor, height uint64, expected string) error {
	version, err := client.call(height).getVersion()
	if err != nil {
		return err
	}
	if version != expected {
		return fmt.Errorf("unexpected version")
	}
	return nil
}

func checkMaxCommitteeSize(client *interactor, height uint64, size int) error {
	maxSize, err := client.call(height).getMaxCommitteeSize()
	if err != nil {
		return err
	}
	if maxSize.Uint64() != uint64(size) {
		return fmt.Errorf("unexpected max committee size")
	}
	return nil
}

// todo: check each enode urls
func checkCommitteeEnodes(client *interactor, height uint64, numEnodes int) error {
	enodes, err := client.call(height).getCommitteeEnodes()
	if err != nil {
		return err
	}
	if len(enodes) != numEnodes {
		return fmt.Errorf("unexpected committee enodes")
	}
	return nil
}

// todo: get committtee from genesis file, and check them on each seat
func checkCommittee(client *interactor, height uint64, lenCommittee int) error {
	committee, err := client.call(height).getCommittee()
	if err != nil {
		return err
	}
	if len(committee) != lenCommittee {
		return fmt.Errorf("unexpected committee")
	}
	return nil
}

// todo: check each validator
func checkValidators(client *interactor, height uint64, numVals int) error {
	vals, err := client.call(height).getValidators()
	if err != nil {
		return err
	}
	if len(vals) != numVals {
		return fmt.Errorf("unexpected validators")
	}
	return nil
}

// todo: check each property of validator
func checkValidator(client *interactor, height uint64, address common.Address, enode string) error {
	val, err := client.call(height).getValidator(address)
	if err != nil {
		return err
	}
	if enode != val.Enode {
		return fmt.Errorf("unexpected validator")
	}
	return nil
}

func checkMinBaseFee(client *interactor, height uint64, minBaseFee int) error {
	fee, err := client.call(height).getMinBaseFee()
	if err != nil {
		return err
	}
	if fee.Uint64() != uint64(minBaseFee) {
		return fmt.Errorf("unexpected min base fee")
	}
	return nil
}

func checkOperatorAddress(client *interactor, height uint64, opAddr common.Address) error {
	op, err := client.call(height).getOperator()
	if err != nil {
		return err
	}
	if op != opAddr {
		return fmt.Errorf("unexpected operator account")
	}
	return nil
}

func checkNewContract(client *interactor, height uint64, byteCode []byte, abi string) error {
	byteC, a, err := client.call(height).getNewContract()
	if err != nil {
		return err
	}
	if !reflect.DeepEqual(byteC, byteCode) || a != abi {
		return fmt.Errorf("unexpected new contract")
	}
	return nil
}

// todo check each bonding requests
func checkBondingReqs(client *interactor, height uint64, s *big.Int, e *big.Int, num int) error {
	reqs, err := client.call(height).getBondingReq(s, e)
	if err != nil {
		return err
	}
	if len(reqs) != num {
		return fmt.Errorf("unexpected bonding reqs")
	}
	return nil
}

// todo check each unbonding requests.
func checkUnBondingReqs(client *interactor, height uint64, s *big.Int, e *big.Int, num int) error {
	reqs, err := client.call(height).getUnBondingReq(s, e)
	if err != nil {
		return err
	}
	if len(reqs) != num {
		return fmt.Errorf("unexpected unbonding reqs")
	}
	return nil
}

// Test the contract upgrade mechanism.
// The new contract is ./autonity/solidity/contracts/Upgrade_test.sol
func TestUpgradeMechanism(t *testing.T) {
	numOfValidators := 3
	operator, err := makeAccount()
	require.NoError(t, err)
	initialOperatorAddr := crypto.PubkeyToAddress(operator.PublicKey)
	//var upgradeTxs []*types.Transaction
	bytecode := common.Hex2Bytes(contractUpgradeBytecode)
	var interactor *interactor
	var transactor *transactor

	testCase := &testCase{
		name:          "Test AC system operator change settings",
		numValidators: numOfValidators,
		numBlocks:     30,
		txPerPeer:     0,
		// set AC configs in genesis hook.
		genesisHook: func(g *core.Genesis) *core.Genesis {
			g.Config.AutonityContractConfig.Operator = initialOperatorAddr
			g.Alloc[initialOperatorAddr] = core.GenesisAccount{
				Balance: new(big.Int).Exp(big.NewInt(2), big.NewInt(128), nil),
			}
			setACConfig(g.Config.AutonityContractConfig)
			return g
		},
		beforeHooks: map[string]hook{"V0": func(block *types.Block, validator *testNode, tCase *testCase, currentTime time.Time) error {
			if block.Number().Uint64() == 2 {
				interactor = interact(validator.rpcPort)
				transactor = interactor.tx(operator)
			}
			return nil
		}},

		afterHooks: map[string]hook{
			// upgrade is triggered at block #5
			"V0": func(block *types.Block, validator *testNode, tCase *testCase, currentTime time.Time) error {
				var err error
				switch block.Number().Uint64() {
				case 5:
					_, err = transactor.upgradeContract(bytecode[0:len(bytecode)/2], "")
				case 10:
					_, err = transactor.upgradeContract(nil, contractUpgradeABI)
				case 15:
					_, err = transactor.upgradeContract(bytecode[len(bytecode)/2:], "")
				default:
					return nil
				}
				return err
			},
			"V2": func(block *types.Block, validator *testNode, tCase *testCase, currentTime time.Time) error {
				if block.Number().Uint64() == 20 {
					if _, err := transactor.completeContractUpgrade(); err != nil {
						return err
					}
				}
				return nil
			},
			"V1": func(block *types.Block, validator *testNode, tCase *testCase, currentTime time.Time) error {
				if block.Number().Uint64() == 25 {
					if _, err = transactor.transfer(common.HexToAddress("0x111"), big.NewInt(1000)); err != nil {
						return err
					}
				}
				return nil
			},
		},
		finalAssert: func(t *testing.T, validators map[string]*testNode) {
			node := validators["V0"]
			client := interact(node.rpcPort)
			defer client.close()
			//upgradeReceipt, err := client.client.TransactionReceipt(context.Background(), upgradeTx.Hash())
			//require.NoError(t, err)
			//t.Log("upgrade gas used:", upgradeReceipt.GasUsed)
			//check that validator 1 has 50 bonded stake. (initial stake is 100)
			val1, err := client.call(node.lastBlock).getValidator(validators["V1"].address)
			require.NoError(t, err)
			require.Equal(t, uint64(50), val1.BondedStake.Uint64())
			//check the contract version is now 2.0.0
			version, err := client.call(node.lastBlock).getVersion()
			require.NoError(t, err)
			require.Equal(t, "2.0.0", version)
			//check the new transfer operation
			balance, err := client.call(node.lastBlock).balanceOf(common.HexToAddress("0x111"))
			require.NoError(t, err)
			require.Equal(t, big.NewInt(2000), balance)
		},
	}
	runTest(t, testCase)
}

func makeAccount() (*ecdsa.PrivateKey, error) {
	return crypto.GenerateKey()
}

func setACConfig(contractConf *params.AutonityContractGenesis) {
	contractConf.BlockPeriod = uint64(blockPeriod)
	contractConf.DelegationRate = uint64(delegationRate)
	contractConf.MaxCommitteeSize = uint64(maxCommitteeSize)
	contractConf.EpochPeriod = uint64(epochPeriod)
	contractConf.MinBaseFee = uint64(minBaseFee)
	contractConf.UnbondingPeriod = uint64(unBondingPeriod)
	contractConf.TreasuryFee = uint64(treasuryFee)
}
