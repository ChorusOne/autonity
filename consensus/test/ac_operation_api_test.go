package test

import (
	"crypto/ecdsa"
	"fmt"
	"github.com/autonity/autonity/common"
	"github.com/autonity/autonity/core"
	"github.com/autonity/autonity/core/types"
	"github.com/autonity/autonity/crypto"
	"github.com/autonity/autonity/p2p/enode"
	"github.com/autonity/autonity/params"
	"github.com/stretchr/testify/require"
	"math/big"
	"reflect"
	"testing"
	"time"
)

const (
	treasuryFee             = 100
	minBaseFee              = 10
	delegationRate          = 1
	epochPeriod             = 5
	unBondingPeriod         = 5
	maxCommitteeSize        = 7
	blockPeriod             = 1
	defaultVersion          = "v0.0.0"
	contractUpgradeBytecode = "60806040523480156200001157600080fd5b506002601d6000600d60018154811062000030576200002f62000365565b5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060040154620000a59190620003cd565b601d6000600d600181548110620000c157620000c062000365565b5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600401819055506040518060400160405280600581526020017f322e302e30000000000000000000000000000000000000000000000000000000815250600360080190805190602001906200017d92919062000229565b506103e8601c6000600360000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550600080620001f89190620002ba565b6001600062000208919062000300565b6000600260006101000a81548160ff0219169083151502179055506200046a565b828054620002379062000434565b90600052602060002090601f0160209004810192826200025b5760008555620002a7565b82601f106200027657805160ff1916838001178555620002a7565b82800160010185558215620002a7579182015b82811115620002a657825182559160200191906001019062000289565b5b509050620002b6919062000346565b5090565b508054620002c89062000434565b6000825580601f10620002dc5750620002fd565b601f016020900490600052602060002090810190620002fc919062000346565b5b50565b5080546200030e9062000434565b6000825580601f1062000322575062000343565b601f01602090049060005260206000209081019062000342919062000346565b5b50565b5b808211156200036157600081600090555060010162000347565b5090565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b6000819050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b6000620003da8262000394565b9150620003e78362000394565b925082620003fa57620003f96200039e565b5b828204905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b600060028204905060018216806200044d57607f821691505b6020821081141562000464576200046362000405565b5b50919050565b618f59806200047a6000396000f3fe608060405260043610620003135760003560e01c8063872cf0591162000199578063ae1f5fa011620000f1578063cb696f5411620000a3578063d886f8a21162000079578063d886f8a21462000c0e578063dd62ed3e1462000c3c578063e485c6fb1462000c80578063e7f43c681462000cc4576200031b565b8063cb696f541462000b96578063cf9c57191462000bc4578063d5f394881462000bde576200031b565b8063ae1f5fa01462000a8d578063b2ea9adb1462000aa7578063b66b3e791462000ad5578063b7ab4db51462000b06578063c2362dd51462000b36578063c9d97af41462000b66576200031b565b8063a416aa06116200014b578063a416aa06146200095f578063a515366a146200098d578063a5d059ca14620009bb578063a8b2216e14620009e9578063a9059cbb1462000a19578063ab8f6ffe1462000a5d576200031b565b8063872cf05914620008595780638bac7dad146200087357806395d89b4114620008a15780639bb851c014620008d15780639c98e47114620009015780639dc29fac1462000931576200031b565b806344697221116200026b5780636b5f444c116200021d57806377e741c711620001f357806377e741c71462000792578063787a243314620007c057806379502c5514620007f0578063819b64631462000829576200031b565b80636b5f444c14620006f057806370a08231146200071e578063731b3a031462000762576200031b565b80634469722114620005aa5780634b0dff6314620005da578063520fdbbc146200060a57806355230e9314620006385780635f7d3949146200067c578063662cd7f414620006c0576200031b565b80631604e41611620002c55780631604e416146200046457806318160ddd14620004945780631904bb2e14620004c457806323b872dd14620005085780633ac25ba8146200054c57806340c10f19146200057c576200031b565b806305261aea146200031d57806306fdde031462000362578063095ea7b314620003925780630d8e6e2c14620003d6578063112206331462000406578063114eaf551462000436576200031b565b366200031b57005b005b3480156200032a57600080fd5b506200034960048036038101906200034391906200554d565b62000cf4565b60405162000359929190620056e2565b60405180910390f35b3480156200036f57600080fd5b506200037a62000ee6565b604051620003899190620057ba565b60405180910390f35b3480156200039f57600080fd5b50620003be6004803603810190620003b891906200580f565b62000f23565b604051620003cd919062005856565b60405180910390f35b348015620003e357600080fd5b50620003ee62000f3c565b604051620003fd9190620057ba565b60405180910390f35b3480156200041357600080fd5b506200041e62000fd9565b6040516200042d919062005884565b60405180910390f35b3480156200044357600080fd5b506200046260048036038101906200045c91906200554d565b62000fe5565b005b3480156200047157600080fd5b506200047c62001088565b6040516200048b919062005884565b60405180910390f35b348015620004a157600080fd5b50620004ac6200108e565b604051620004bb919062005884565b60405180910390f35b348015620004d157600080fd5b50620004f06004803603810190620004ea9190620058a1565b62001098565b604051620004ff919062005b3a565b60405180910390f35b3480156200051557600080fd5b506200053460048036038101906200052e919062005b5e565b6200130d565b60405162000543919062005856565b60405180910390f35b3480156200055957600080fd5b5062000564620013c3565b60405162000573919062005884565b60405180910390f35b3480156200058957600080fd5b50620005a86004803603810190620005a291906200580f565b620013de565b005b348015620005b757600080fd5b50620005c262001573565b604051620005d1919062005884565b60405180910390f35b348015620005e757600080fd5b50620005f262001579565b60405162000601919062005884565b60405180910390f35b3480156200061757600080fd5b50620006366004803603810190620006309190620058a1565b6200157f565b005b3480156200064557600080fd5b506200066460048036038101906200065e919062005bba565b6200165c565b60405162000673919062005d1b565b60405180910390f35b3480156200068957600080fd5b50620006a86004803603810190620006a2919062005bba565b62001810565b604051620006b7919062005d50565b60405180910390f35b348015620006cd57600080fd5b50620006d862001a23565b604051620006e7919062005884565b60405180910390f35b348015620006fd57600080fd5b506200071c60048036038101906200071691906200554d565b62001a29565b005b3480156200072b57600080fd5b506200074a6004803603810190620007449190620058a1565b62001acc565b60405162000759919062005884565b60405180910390f35b3480156200076f57600080fd5b506200077a62001b15565b60405162000789919062005884565b60405180910390f35b3480156200079f57600080fd5b50620007be6004803603810190620007b891906200554d565b62001b1f565b005b348015620007cd57600080fd5b50620007d862001bc2565b604051620007e7919062005884565b60405180910390f35b348015620007fd57600080fd5b506200080862001bc8565b604051620008209a9998979695949392919062005d7e565b60405180910390f35b3480156200083657600080fd5b506200084162001cda565b60405162000850919062005884565b60405180910390f35b3480156200086657600080fd5b506200087162001ce7565b005b3480156200088057600080fd5b506200089f60048036038101906200089991906200554d565b62001d9a565b005b348015620008ae57600080fd5b50620008b962001e83565b604051620008c89190620057ba565b60405180910390f35b348015620008de57600080fd5b50620008e962001ec0565b604051620008f8919062005884565b60405180910390f35b3480156200090e57600080fd5b506200091962001ec6565b60405162000928919062005884565b60405180910390f35b3480156200093e57600080fd5b506200095d60048036038101906200095791906200580f565b62001ecc565b005b3480156200096c57600080fd5b506200098b600480360381019062000985919062005f86565b62002099565b005b3480156200099a57600080fd5b50620009b96004803603810190620009b391906200580f565b620021a2565b005b348015620009c857600080fd5b50620009e76004803603810190620009e191906200580f565b62002345565b005b348015620009f657600080fd5b5062000a01620024e8565b60405162000a109190620060a7565b60405180910390f35b34801562000a2657600080fd5b5062000a45600480360381019062000a3f91906200580f565b620025cb565b60405162000a54919062005856565b60405180910390f35b34801562000a6a57600080fd5b5062000a75620025e4565b60405162000a849190620060cb565b60405180910390f35b34801562000a9a57600080fd5b5062000aa5620026a5565b005b34801562000ab457600080fd5b5062000ad3600480360381019062000acd9190620061a3565b620030a8565b005b34801562000ae257600080fd5b5062000aed6200315c565b60405162000afd92919062006285565b60405180910390f35b34801562000b1357600080fd5b5062000b1e62003293565b60405162000b2d91906200637d565b60405180910390f35b34801562000b4357600080fd5b5062000b4e62003323565b60405162000b5d919062005884565b60405180910390f35b34801562000b7357600080fd5b5062000b7e62003329565b60405162000b8d919062005884565b60405180910390f35b34801562000ba357600080fd5b5062000bc2600480360381019062000bbc91906200554d565b6200332f565b005b34801562000bd157600080fd5b5062000bdc6200340a565b005b34801562000beb57600080fd5b5062000bf6620034dc565b60405162000c05919062005d50565b60405180910390f35b34801562000c1b57600080fd5b5062000c3a600480360381019062000c349190620063d2565b62003502565b005b34801562000c4957600080fd5b5062000c68600480360381019062000c62919062006404565b620035df565b60405162000c77919062005884565b60405180910390f35b34801562000c8d57600080fd5b5062000cac600480360381019062000ca6919062005bba565b62003666565b60405162000cbb919062005d1b565b60405180910390f35b34801562000cd157600080fd5b5062000cdc6200381a565b60405162000ceb919062005d50565b60405180910390f35b600060603373ffffffffffffffffffffffffffffffffffffffff16601f60009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161462000d8b576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040162000d8290620064c1565b60405180910390fd5b826013600082825462000d9f919062006512565b9250508190555043600360050154600f5462000dbc919062006512565b141562000e105762000dd060135462003847565b600060138190555062000de262003b2b565b62000dec620026a5565b43600f819055506001600e600082825462000e08919062006512565b925050819055505b600260009054906101000a900460ff16601180805480602002602001604051908101604052809291908181526020016000905b8282101562000ed757838290600052602060002090600202016040518060400160405290816000820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020016001820154815250508152602001906001019062000e43565b50505050905091509150915091565b60606040518060400160405280600681526020017f4e6577746f6e0000000000000000000000000000000000000000000000000000815250905090565b600062000f3233848462003bfc565b6001905092915050565b60606003600801805462000f50906200659e565b80601f016020809104026020016040519081016040528092919081815260200182805462000f7e906200659e565b801562000fcf5780601f1062000fa35761010080835404028352916020019162000fcf565b820191906000526020600020905b81548152906001019060200180831162000fb157829003601f168201915b5050505050905090565b60006003800154905090565b3373ffffffffffffffffffffffffffffffffffffffff16600360000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16146200107b576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401620010729062006624565b60405180910390fd5b8060036006018190555050565b60135481565b6000601e54905090565b620010a2620051d4565b601d60008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020604051806101600160405290816000820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020016001820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001600282018054620011ab906200659e565b80601f0160208091040260200160405190810160405280929190818152602001828054620011d9906200659e565b80156200122a5780601f10620011fe576101008083540402835291602001916200122a565b820191906000526020600020905b8154815290600101906020018083116200120c57829003601f168201915b50505050508152602001600382015481526020016004820154815260200160058201548152602001600682015481526020016007820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020016008820154815260200160098201548152602001600a820160009054906101000a900460ff166002811115620012ed57620012ec620059b5565b5b6002811115620013025762001301620059b5565b5b815250509050919050565b60006200131c84848462003dcf565b600082601560008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054620013a8919062006646565b9050620013b785338362003bfc565b60019150509392505050565b60006003600701546002620013d9919062006681565b905090565b3373ffffffffffffffffffffffffffffffffffffffff16600360000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161462001474576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016200146b9062006624565b60405180910390fd5b6710000000000000008110620014c1576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401620014b89062006758565b60405180910390fd5b80601c60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825462001512919062006512565b9250508190555080601e60008282546200152d919062006512565b925050819055507f48490b4407bb949b708ec5f514b4167f08f4969baaf78d53b05028adf369bfcf8282604051620015679291906200677a565b60405180910390a15050565b60185481565b601b5481565b3373ffffffffffffffffffffffffffffffffffffffff16600360000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161462001615576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016200160c9062006624565b60405180910390fd5b80600360000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b6060600083836200166e919062006646565b67ffffffffffffffff8111156200168a576200168962005e3f565b5b604051908082528060200260200182016040528015620016c757816020015b620016b362005285565b815260200190600190039081620016a95790505b50905060005b8484620016db919062006646565b8110156200180557601960008287620016f5919062006512565b81526020019081526020016000206040518060800160405290816000820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020016001820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200160028201548152602001600382015481525050828281518110620017e457620017e3620067a7565b5b60200260200101819052508080620017fc90620067d6565b915050620016cd565b508091505092915050565b6000806000905060005b6011805490508110156200187657601181815481106200183f576200183e620067a7565b5b906000526020600020906002020160010154826200185e919062006512565b915080806200186d90620067d6565b9150506200181a565b506000811415620018be576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401620018b59062006874565b60405180910390fd5b60008385620018ce919062006512565b9050600081604051602001620018e59190620068bb565b6040516020818303038152906040528051906020012060001c90506000838262001910919062006907565b90506000805b601180549050811015620019df57601181815481106200193b576200193a620067a7565b5b906000526020600020906002020160010154826200195a919062006512565b91506001826200196b919062006646565b8311620019c95760118181548110620019895762001988620067a7565b5b906000526020600020906002020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16965050505050505062001a1d565b8080620019d690620067d6565b91505062001916565b506040517f08c379a000000000000000000000000000000000000000000000000000000000815260040162001a1490620069b5565b60405180910390fd5b92915050565b601a5481565b3373ffffffffffffffffffffffffffffffffffffffff16600360000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161462001abf576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040162001ab69062006624565b60405180910390fd5b8060036005018190555050565b6000601c60008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b6000600f54905090565b3373ffffffffffffffffffffffffffffffffffffffff16600360000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161462001bb5576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040162001bac9062006624565b60405180910390fd5b8060036002018190555050565b60175481565b60038060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16908060010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff169080600201549080600301549080600401549080600501549080600601549080600701549080600801805462001c4b906200659e565b80601f016020809104026020016040519081016040528092919081815260200182805462001c79906200659e565b801562001cca5780601f1062001c9e5761010080835404028352916020019162001cca565b820191906000526020600020905b81548152906001019060200180831162001cac57829003601f168201915b505050505090806009015490508a565b6000600360070154905090565b3373ffffffffffffffffffffffffffffffffffffffff16600360000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161462001d7d576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040162001d749062006624565b60405180910390fd5b6001600260006101000a81548160ff021916908315150217905550565b3373ffffffffffffffffffffffffffffffffffffffff16600360000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161462001e30576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040162001e279062006624565b60405180910390fd5b6000811162001e76576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040162001e6d9062006a27565b60405180910390fd5b8060036007018190555050565b60606040518060400160405280600381526020017f4e544e0000000000000000000000000000000000000000000000000000000000815250905090565b60125481565b60105481565b3373ffffffffffffffffffffffffffffffffffffffff16600360000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161462001f62576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040162001f599062006624565b60405180910390fd5b80601c60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054101562001fe7576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040162001fde9062006a99565b60405180910390fd5b80601c60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825462002038919062006646565b9250508190555080601e600082825462002053919062006646565b925050819055507f5024dbeedf0c06664c9bd7be836915730c955e936972c020683dadf11d5488a382826040516200208d9291906200677a565b60405180910390a15050565b60006040518061016001604052803373ffffffffffffffffffffffffffffffffffffffff168152602001600073ffffffffffffffffffffffffffffffffffffffff1681526020018381526020016003600401548152602001600081526020016000815260200160008152602001600073ffffffffffffffffffffffffffffffffffffffff1681526020016000815260200143815260200160006002811115620021475762002146620059b5565b5b8152509050620021578162003f99565b7f6921859367aca5023ddf910758cd0cda74261b2e5c8425c253e9d03b62b950b8338260200151848460e0015160405162002196949392919062006abb565b60405180910390a15050565b8173ffffffffffffffffffffffffffffffffffffffff16601d60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161462002275576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016200226c9062006b5f565b60405180910390fd5b600060028111156200228c576200228b620059b5565b5b601d60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600a0160009054906101000a900460ff166002811115620022f157620022f0620059b5565b5b1462002334576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016200232b9062006bd1565b60405180910390fd5b6200234182823362004422565b5050565b8173ffffffffffffffffffffffffffffffffffffffff16601d60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161462002418576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016200240f9062006b5f565b60405180910390fd5b600060028111156200242f576200242e620059b5565b5b601d60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600a0160009054906101000a900460ff166002811115620024945762002493620059b5565b5b14620024d7576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401620024ce9062006bd1565b60405180910390fd5b620024e482823362004671565b5050565b60606014805480602002602001604051908101604052809291908181526020016000905b82821015620025c25783829060005260206000200180546200252e906200659e565b80601f01602080910402602001604051908101604052809291908181526020018280546200255c906200659e565b8015620025ad5780601f106200258157610100808354040283529160200191620025ad565b820191906000526020600020905b8154815290600101906020018083116200258f57829003601f168201915b5050505050815260200190600101906200250c565b50505050905090565b6000620025da33848462003dcf565b6001905092915050565b60606011805480602002602001604051908101604052809291908181526020016000905b828210156200269c57838290600052602060002090600202016040518060400160405290816000820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020016001820154815250508152602001906001019062002608565b50505050905090565b3373ffffffffffffffffffffffffffffffffffffffff16601f60009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161462002738576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016200272f90620064c1565b60405180910390fd5b6000600d805490501162002783576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016200277a9062006c43565b60405180910390fd5b6000805b600d80549050811015620029105760006002811115620027ac57620027ab620059b5565b5b601d6000600d8481548110620027c757620027c6620067a7565b5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600a0160009054906101000a900460ff166002811115620028525762002851620059b5565b5b148015620028e357506000601d6000600d8481548110620028785762002877620067a7565b5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060040154115b15620028fa578180620028f690620067d6565b9250505b80806200290790620067d6565b91505062002787565b506000600360070154905081811062002927578190505b60008267ffffffffffffffff81111562002946576200294562005e3f565b5b6040519080825280602002602001820160405280156200298357816020015b6200296f620051d4565b815260200190600190039081620029655790505b50905060008267ffffffffffffffff811115620029a557620029a462005e3f565b5b604051908082528060200260200182016040528015620029e257816020015b620029ce620051d4565b815260200190600190039081620029c45790505b5090506000805b600d8054905081101562002e3e576000600281111562002a0e5762002a0d620059b5565b5b601d6000600d848154811062002a295762002a28620067a7565b5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600a0160009054906101000a900460ff16600281111562002ab45762002ab3620059b5565b5b14801562002b4557506000601d6000600d848154811062002ada5762002ad9620067a7565b5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060040154115b1562002e28576000601d6000600d848154811062002b685762002b67620067a7565b5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020604051806101600160405290816000820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020016001820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200160028201805462002c97906200659e565b80601f016020809104026020016040519081016040528092919081815260200182805462002cc5906200659e565b801562002d165780601f1062002cea5761010080835404028352916020019162002d16565b820191906000526020600020905b81548152906001019060200180831162002cf857829003601f168201915b50505050508152602001600382015481526020016004820154815260200160058201548152602001600682015481526020016007820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020016008820154815260200160098201548152602001600a820160009054906101000a900460ff16600281111562002dd95762002dd8620059b5565b5b600281111562002dee5762002ded620059b5565b5b8152505090508085848151811062002e0b5762002e0a620067a7565b5b6020026020010181905250828062002e2390620067d6565b935050505b808062002e3590620067d6565b915050620029e9565b506003600701548351111562002ec65762002e59836200499c565b60005b60036007015481101562002ebf5783818151811062002e805762002e7f620067a7565b5b602002602001015183828151811062002e9e5762002e9d620067a7565b5b6020026020010181905250808062002eb690620067d6565b91505062002e5c565b5062002eca565b8291505b6011600062002eda9190620052d9565b6014600062002eea9190620052ff565b600060108190555060005b84811015620030a0576000604051806040016040528085848151811062002f215762002f20620067a7565b5b60200260200101516020015173ffffffffffffffffffffffffffffffffffffffff16815260200185848151811062002f5e5762002f5d620067a7565b5b6020026020010151608001518152509050601181908060018154018082558091505060019003906000526020600020906002020160009091909190915060008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506020820151816001015550506014848381518110620030065762003005620067a7565b5b6020026020010151604001519080600181540180825580915050600190039060005260206000200160009091909190915090805190602001906200304c92919062005322565b50838281518110620030635762003062620067a7565b5b6020026020010151608001516010600082825462003082919062006512565b925050819055505080806200309790620067d6565b91505062002ef5565b505050505050565b3373ffffffffffffffffffffffffffffffffffffffff16600360000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16146200313e576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401620031359062006624565b60405180910390fd5b6200314b600083620049bc565b62003158600182620049bc565b5050565b6060806000600181805462003171906200659e565b80601f01602080910402602001604051908101604052809291908181526020018280546200319f906200659e565b8015620031f05780601f10620031c457610100808354040283529160200191620031f0565b820191906000526020600020905b815481529060010190602001808311620031d257829003601f168201915b5050505050915080805462003205906200659e565b80601f016020809104026020016040519081016040528092919081815260200182805462003233906200659e565b8015620032845780601f10620032585761010080835404028352916020019162003284565b820191906000526020600020905b8154815290600101906020018083116200326657829003601f168201915b50505050509050915091509091565b6060600d8054806020026020016040519081016040528092919081815260200182805480156200331957602002820191906000526020600020905b8160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019060010190808311620032ce575b5050505050905090565b600f5481565b600e5481565b3373ffffffffffffffffffffffffffffffffffffffff16600360000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614620033c5576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401620033bc9062006624565b60405180910390fd5b8060038001819055507f1f4d2fc7529047a5bd96d3229bfea127fd18b7748f13586e097c69fccd38912881604051620033ff919062005884565b60405180910390a150565b3373ffffffffffffffffffffffffffffffffffffffff16600360000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614620034a0576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401620034979062006624565b60405180910390fd5b600080620034af9190620053b3565b60016000620034bf9190620053f9565b6000600260006101000a81548160ff021916908315150217905550565b601f60009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b3373ffffffffffffffffffffffffffffffffffffffff16600360000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161462003598576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016200358f9062006624565b60405180910390fd5b80600360010160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b6000601560008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905092915050565b60606000838362003678919062006646565b67ffffffffffffffff81111562003694576200369362005e3f565b5b604051908082528060200260200182016040528015620036d157816020015b620036bd62005285565b815260200190600190039081620036b35790505b50905060005b8484620036e5919062006646565b8110156200380f57601660008287620036ff919062006512565b81526020019081526020016000206040518060800160405290816000820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020016001820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200160028201548152602001600382015481525050828281518110620037ee57620037ed620067a7565b5b602002602001018190525080806200380690620067d6565b915050620036d7565b508091505092915050565b6000600360000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b804710156200388d576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401620038849062006cdb565b60405180910390fd5b6000670de0b6b3a764000082600360020154620038ab919062006681565b620038b7919062006cfd565b905060008111156200394157600360010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc829081150290604051600060405180830381858888f193505050501580156200392f573d6000803e3d6000fd5b5080826200393e919062006646565b91505b816012600082825462003955919062006512565b9250508190555060005b60118054905081101562003b26576000601d6000601184815481106200398a5762003989620067a7565b5b906000526020600020906002020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000209050600060105485836004015462003a0f919062006681565b62003a1b919062006cfd565b9050600081111562003aaf578160070160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663fb489a7b826040518263ffffffff1660e01b81526004016000604051808303818588803b15801562003a9457600080fd5b505af115801562003aa9573d6000803e3d6000fd5b50505050505b7fb3b7a071186534c03b40695710096f289fd4ed6c1a374aff0bb648955e4fe5638260010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff168260405162003b069291906200677a565b60405180910390a15050808062003b1d90620067d6565b9150506200395f565b505050565b600060175490505b60185481101562003b5f5762003b498162004b37565b808062003b5690620067d6565b91505062003b33565b506018546017819055506000601a5490506000601a5490505b601b5481101562003bf15743600360060154601960008481526020019081526020016000206003015462003bad919062006512565b1162003bd55762003bbe8162004d97565b60018262003bcd919062006512565b915062003bdb565b62003bf1565b808062003be890620067d6565b91505062003b78565b5080601a8190555050565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff16141562003c6f576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040162003c669062006dab565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff16141562003ce2576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040162003cd99062006e43565b60405180910390fd5b80601560008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b9258360405162003dc2919062005884565b60405180910390a3505050565b80601c60008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054101562003e54576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040162003e4b9062006eb5565b60405180910390fd5b80601c60008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825462003ea5919062006646565b9250508190555080601e600082825462003ec0919062006512565b9250508190555080600262003ed6919062006681565b601c60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825462003f26919062006512565b925050819055508173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef8360405162003f8c919062005884565b60405180910390a3505050565b600062003faa826040015162004f9b565b836020018193508273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681525050506000811462004029576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401620040209062006f27565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff16601d6000846020015173ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161462004101576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401620040f89062006f99565b60405180910390fd5b633b9aca00826060015111156200414f576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040162004146906200700b565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168260e0015173ffffffffffffffffffffffffffffffffffffffff1614156200420a57816020015182600001518360600151604051620041a6906200543f565b620041b4939291906200702d565b604051809103906000f080158015620041d1573d6000803e3d6000fd5b508260e0019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff16815250505b600d82602001519080600181540180825580915050600190039060005260206000200160009091909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555081601d6000846020015173ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060208201518160010160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060408201518160020190805190602001906200436192919062005322565b50606082015181600301556080820151816004015560a0820151816005015560c0820151816006015560e08201518160070160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506101008201518160080155610120820151816009015561014082015181600a0160006101000a81548160ff02191690836002811115620044165762004415620059b5565b5b02179055509050505050565b6000821162004468576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016200445f90620070e0565b60405180910390fd5b81601c60008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020541015620044ed576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401620044e49062007152565b60405180910390fd5b81601c60008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282546200453e919062006646565b92505081905550600060405180608001604052808373ffffffffffffffffffffffffffffffffffffffff1681526020018573ffffffffffffffffffffffffffffffffffffffff1681526020018481526020014381525090508060166000601854815260200190815260200160002060008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060208201518160010160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506040820151816002015560608201518160030155905050601860008154809291906200466690620067d6565b919050555050505050565b6000601d60008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060070160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166370a08231836040518263ffffffff1660e01b815260040162004710919062007199565b602060405180830381865afa1580156200472e573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620047549190620071cd565b9050828110156200479c576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401620047939062007275565b60405180910390fd5b601d60008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060070160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16639dc29fac83856040518363ffffffff1660e01b81526004016200483b92919062007297565b600060405180830381600087803b1580156200485657600080fd5b505af11580156200486b573d6000803e3d6000fd5b50505050600060405180608001604052808473ffffffffffffffffffffffffffffffffffffffff1681526020018673ffffffffffffffffffffffffffffffffffffffff1681526020018581526020014381525090508060196000601b54815260200190815260200160002060008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060208201518160010160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506040820151816002015560608201518160030155905050601b60008154809291906200499090620067d6565b91905055505050505050565b620049b981600060018451620049b3919062006646565b62004ffc565b50565b81546002600180831615610100020382160482518082016020811060208410016002811462004a72576001811462004a98578660005260208404602060002001600160028402018855602085066020850681602003808a01878b016001836101000a038083511687540187556001870196506020830192505b8183101562004a54578251875560018701965060208301925062004a35565b8183036101000a905080818451040287555050505050505062004b2e565b60028302826020036101000a846020036101000a60208901510402018501875562004b2e565b8660005260208404602060002001600160028402018855846020038088018589016001836101000a03808351167fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff008b160185556020830192506001850194505b8183101562004b17578251855560018501945060208301925062004af8565b8183036101000a9050808184510402855550505050505b50505050505050565b60006016600083815260200190815260200160002090506000601d60008360010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002090506000808260040154141562004bd1578260020154905062004bfb565b81600401548360020154836008015462004bec919062006681565b62004bf8919062006cfd565b90505b8160070160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166340c10f198460000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16836040518363ffffffff1660e01b815260040162004c8092919062007297565b600060405180830381600087803b15801562004c9b57600080fd5b505af115801562004cb0573d6000803e3d6000fd5b50505050826002015482600401600082825462004cce919062006512565b925050819055508160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168360000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16141562004d7457826002015482600501600082825462004d6c919062006512565b925050819055505b8082600801600082825462004d8a919062006512565b9250508190555050505050565b60006019600083815260200190815260200160002090506000601d60008360010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000209050600081600801548260040154846002015462004e32919062006681565b62004e3e919062006cfd565b90508082600401600082825462004e56919062006646565b925050819055508160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168360000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16141562004ef8578082600501600082825462004ef0919062006646565b925050819055505b826002015482600801600082825462004f12919062006646565b9250508190555080601c60008560000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825462004f8e919062006512565b9250508190555050505050565b60008062004fa86200544d565b600060408286516020880160ff5afa62004fc157600080fd5b6c010000000000000000000000008251049050808260016002811062004fec5762004feb620067a7565b5b6020020151935093505050915091565b600082905060008290508082141562005017575050620051cf565b600085600286866200502a9190620072ce565b6200503691906200736c565b86620050439190620073e0565b81518110620050575762005056620067a7565b5b60200260200101516080015190505b8183136200519d575b80868481518110620050865762005085620067a7565b5b6020026020010151608001511115620050af578280620050a6906200747e565b9350506200506f565b5b858281518110620050c657620050c5620067a7565b5b602002602001015160800151811115620050f0578180620050e790620074cc565b925050620050b0565b81831362005197578582815181106200510e576200510d620067a7565b5b60200260200101518684815181106200512c576200512b620067a7565b5b60200260200101518785815181106200514a5762005149620067a7565b5b60200260200101888581518110620051675762005166620067a7565b5b602002602001018290528290525050828062005183906200747e565b93505081806200519390620074cc565b9250505b62005066565b81851215620051b457620051b386868462004ffc565b5b83831215620051cb57620051ca86848662004ffc565b5b5050505b505050565b604051806101600160405280600073ffffffffffffffffffffffffffffffffffffffff168152602001600073ffffffffffffffffffffffffffffffffffffffff1681526020016060815260200160008152602001600081526020016000815260200160008152602001600073ffffffffffffffffffffffffffffffffffffffff1681526020016000815260200160008152602001600060028111156200527f576200527e620059b5565b5b81525090565b6040518060800160405280600073ffffffffffffffffffffffffffffffffffffffff168152602001600073ffffffffffffffffffffffffffffffffffffffff16815260200160008152602001600081525090565b5080546000825560020290600052602060002090810190620052fc91906200546f565b50565b50805460008255906000526020600020908101906200531f9190620054b7565b50565b82805462005330906200659e565b90600052602060002090601f016020900481019282620053545760008555620053a0565b82601f106200536f57805160ff1916838001178555620053a0565b82800160010185558215620053a0579182015b828111156200539f57825182559160200191906001019062005382565b5b509050620053af9190620054df565b5090565b508054620053c1906200659e565b6000825580601f10620053d55750620053f6565b601f016020900490600052602060002090810190620053f59190620054df565b5b50565b50805462005407906200659e565b6000825580601f106200541b57506200543c565b601f0160209004906000526020600020908101906200543b9190620054df565b5b50565b611a09806200751b83390190565b6040518060400160405280600290602082028036833780820191505090505090565b5b80821115620054b357600080820160006101000a81549073ffffffffffffffffffffffffffffffffffffffff021916905560018201600090555060020162005470565b5090565b5b80821115620054db5760008181620054d19190620053f9565b50600101620054b8565b5090565b5b80821115620054fa576000816000905550600101620054e0565b5090565b6000604051905090565b600080fd5b600080fd5b6000819050919050565b620055278162005512565b81146200553357600080fd5b50565b60008135905062005547816200551c565b92915050565b60006020828403121562005566576200556562005508565b5b6000620055768482850162005536565b91505092915050565b60008115159050919050565b62005596816200557f565b82525050565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000620055f582620055c8565b9050919050565b6200560781620055e8565b82525050565b620056188162005512565b82525050565b604082016000820151620056366000850182620055fc565b5060208201516200564b60208501826200560d565b50505050565b60006200565f83836200561e565b60408301905092915050565b6000602082019050919050565b600062005685826200559c565b620056918185620055a7565b93506200569e83620055b8565b8060005b83811015620056d5578151620056b9888262005651565b9750620056c6836200566b565b925050600181019050620056a2565b5085935050505092915050565b6000604082019050620056f960008301856200558b565b81810360208301526200570d818462005678565b90509392505050565b600081519050919050565b600082825260208201905092915050565b60005b838110156200575257808201518184015260208101905062005735565b8381111562005762576000848401525b50505050565b6000601f19601f8301169050919050565b6000620057868262005716565b62005792818562005721565b9350620057a481856020860162005732565b620057af8162005768565b840191505092915050565b60006020820190508181036000830152620057d6818462005779565b905092915050565b620057e981620055e8565b8114620057f557600080fd5b50565b6000813590506200580981620057de565b92915050565b6000806040838503121562005829576200582862005508565b5b60006200583985828601620057f8565b92505060206200584c8582860162005536565b9150509250929050565b60006020820190506200586d60008301846200558b565b92915050565b6200587e8162005512565b82525050565b60006020820190506200589b600083018462005873565b92915050565b600060208284031215620058ba57620058b962005508565b5b6000620058ca84828501620057f8565b91505092915050565b6000620058e082620055c8565b9050919050565b620058f281620058d3565b82525050565b600082825260208201905092915050565b6000620059168262005716565b620059228185620058f8565b93506200593481856020860162005732565b6200593f8162005768565b840191505092915050565b6000819050919050565b6000620059756200596f6200596984620055c8565b6200594a565b620055c8565b9050919050565b6000620059898262005954565b9050919050565b60006200599d826200597c565b9050919050565b620059af8162005990565b82525050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602160045260246000fd5b60038110620059f857620059f7620059b5565b5b50565b600081905062005a0b82620059e4565b919050565b600062005a1d82620059fb565b9050919050565b62005a2f8162005a10565b82525050565b60006101608301600083015162005a506000860182620058e7565b50602083015162005a656020860182620055fc565b506040830151848203604086015262005a7f828262005909565b915050606083015162005a9660608601826200560d565b50608083015162005aab60808601826200560d565b5060a083015162005ac060a08601826200560d565b5060c083015162005ad560c08601826200560d565b5060e083015162005aea60e0860182620059a4565b5061010083015162005b016101008601826200560d565b5061012083015162005b186101208601826200560d565b5061014083015162005b2f61014086018262005a24565b508091505092915050565b6000602082019050818103600083015262005b56818462005a35565b905092915050565b60008060006060848603121562005b7a5762005b7962005508565b5b600062005b8a86828701620057f8565b935050602062005b9d86828701620057f8565b925050604062005bb08682870162005536565b9150509250925092565b6000806040838503121562005bd45762005bd362005508565b5b600062005be48582860162005536565b925050602062005bf78582860162005536565b9150509250929050565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b60808201600082015162005c456000850182620058e7565b50602082015162005c5a6020850182620055fc565b50604082015162005c6f60408501826200560d565b50606082015162005c8460608501826200560d565b50505050565b600062005c98838362005c2d565b60808301905092915050565b6000602082019050919050565b600062005cbe8262005c01565b62005cca818562005c0c565b935062005cd78362005c1d565b8060005b8381101562005d0e57815162005cf2888262005c8a565b975062005cff8362005ca4565b92505060018101905062005cdb565b5085935050505092915050565b6000602082019050818103600083015262005d37818462005cb1565b905092915050565b62005d4a81620055e8565b82525050565b600060208201905062005d67600083018462005d3f565b92915050565b62005d7881620058d3565b82525050565b60006101408201905062005d96600083018d62005d3f565b62005da5602083018c62005d6d565b62005db4604083018b62005873565b62005dc3606083018a62005873565b62005dd2608083018962005873565b62005de160a083018862005873565b62005df060c083018762005873565b62005dff60e083018662005873565b81810361010083015262005e14818562005779565b905062005e2661012083018462005873565b9b9a5050505050505050505050565b600080fd5b600080fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b62005e798262005768565b810181811067ffffffffffffffff8211171562005e9b5762005e9a62005e3f565b5b80604052505050565b600062005eb0620054fe565b905062005ebe828262005e6e565b919050565b600067ffffffffffffffff82111562005ee15762005ee062005e3f565b5b62005eec8262005768565b9050602081019050919050565b82818337600083830152505050565b600062005f1f62005f198462005ec3565b62005ea4565b90508281526020810184848401111562005f3e5762005f3d62005e3a565b5b62005f4b84828562005ef9565b509392505050565b600082601f83011262005f6b5762005f6a62005e35565b5b813562005f7d84826020860162005f08565b91505092915050565b60006020828403121562005f9f5762005f9e62005508565b5b600082013567ffffffffffffffff81111562005fc05762005fbf6200550d565b5b62005fce8482850162005f53565b91505092915050565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b600062006011838362005909565b905092915050565b6000602082019050919050565b6000620060338262005fd7565b6200603f818562005fe2565b935083602082028501620060538562005ff3565b8060005b8581101562006095578484038952815162006073858262006003565b9450620060808362006019565b925060208a0199505060018101905062006057565b50829750879550505050505092915050565b60006020820190508181036000830152620060c3818462006026565b905092915050565b60006020820190508181036000830152620060e7818462005678565b905092915050565b600067ffffffffffffffff8211156200610d576200610c62005e3f565b5b620061188262005768565b9050602081019050919050565b60006200613c6200613684620060ef565b62005ea4565b9050828152602081018484840111156200615b576200615a62005e3a565b5b6200616884828562005ef9565b509392505050565b600082601f83011262006188576200618762005e35565b5b81356200619a84826020860162006125565b91505092915050565b60008060408385031215620061bd57620061bc62005508565b5b600083013567ffffffffffffffff811115620061de57620061dd6200550d565b5b620061ec8582860162006170565b925050602083013567ffffffffffffffff81111562006210576200620f6200550d565b5b6200621e8582860162005f53565b9150509250929050565b600081519050919050565b600082825260208201905092915050565b6000620062518262006228565b6200625d818562006233565b93506200626f81856020860162005732565b6200627a8162005768565b840191505092915050565b60006040820190508181036000830152620062a1818562006244565b90508181036020830152620062b7818462005779565b90509392505050565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b6000620062fa8383620055fc565b60208301905092915050565b6000602082019050919050565b60006200632082620062c0565b6200632c8185620062cb565b93506200633983620062dc565b8060005b8381101562006370578151620063548882620062ec565b9750620063618362006306565b9250506001810190506200633d565b5085935050505092915050565b6000602082019050818103600083015262006399818462006313565b905092915050565b620063ac81620058d3565b8114620063b857600080fd5b50565b600081359050620063cc81620063a1565b92915050565b600060208284031215620063eb57620063ea62005508565b5b6000620063fb84828501620063bb565b91505092915050565b600080604083850312156200641e576200641d62005508565b5b60006200642e85828601620057f8565b92505060206200644185828601620057f8565b9150509250929050565b7f66756e6374696f6e207265737472696374656420746f207468652070726f746f60008201527f636f6c0000000000000000000000000000000000000000000000000000000000602082015250565b6000620064a960238362005721565b9150620064b6826200644b565b604082019050919050565b60006020820190508181036000830152620064dc816200649a565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60006200651f8262005512565b91506200652c8362005512565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff03821115620065645762006563620064e3565b5b828201905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b60006002820490506001821680620065b757607f821691505b60208210811415620065ce57620065cd6200656f565b5b50919050565b7f63616c6c6572206973206e6f7420746865206f70657261746f72000000000000600082015250565b60006200660c601a8362005721565b91506200661982620065d4565b602082019050919050565b600060208201905081810360008301526200663f81620065fd565b9050919050565b6000620066538262005512565b9150620066608362005512565b925082821015620066765762006675620064e3565b5b828203905092915050565b60006200668e8262005512565b91506200669b8362005512565b9250817fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0483118215151615620066d757620066d6620064e3565b5b828202905092915050565b7f697373756564204e6577746f6e2063616e27742062652067726561746572207460008201527f68616e20325e3630000000000000000000000000000000000000000000000000602082015250565b60006200674060288362005721565b91506200674d82620066e2565b604082019050919050565b60006020820190508181036000830152620067738162006731565b9050919050565b600060408201905062006791600083018562005d3f565b620067a0602083018462005873565b9392505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b6000620067e38262005512565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff821415620068195762006818620064e3565b5b600182019050919050565b7f54686520636f6d6d6974746565206973206e6f74207374616b696e6700000000600082015250565b60006200685c601c8362005721565b9150620068698262006824565b602082019050919050565b600060208201905081810360008301526200688f816200684d565b9050919050565b6000819050919050565b620068b5620068af8262005512565b62006896565b82525050565b6000620068c98284620068a0565b60208201915081905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b6000620069148262005512565b9150620069218362005512565b925082620069345762006933620068d8565b5b828206905092915050565b7f5468657265206973206e6f2076616c696461746f72206c65667420696e20746860008201527f65206e6574776f726b0000000000000000000000000000000000000000000000602082015250565b60006200699d60298362005721565b9150620069aa826200693f565b604082019050919050565b60006020820190508181036000830152620069d0816200698e565b9050919050565b7f636f6d6d69747465652073697a652063616e2774206265203000000000000000600082015250565b600062006a0f60198362005721565b915062006a1c82620069d7565b602082019050919050565b6000602082019050818103600083015262006a428162006a00565b9050919050565b7f416d6f756e7420657863656564732062616c616e636500000000000000000000600082015250565b600062006a8160168362005721565b915062006a8e8262006a49565b602082019050919050565b6000602082019050818103600083015262006ab48162006a72565b9050919050565b600060808201905062006ad2600083018762005d3f565b62006ae1602083018662005d3f565b818103604083015262006af5818562005779565b905062006b06606083018462005d3f565b95945050505050565b7f76616c696461746f72206e6f7420726567697374657265640000000000000000600082015250565b600062006b4760188362005721565b915062006b548262006b0f565b602082019050919050565b6000602082019050818103600083015262006b7a8162006b38565b9050919050565b7f76616c696461746f72206e65656420746f20626520656e61626c656400000000600082015250565b600062006bb9601c8362005721565b915062006bc68262006b81565b602082019050919050565b6000602082019050818103600083015262006bec8162006baa565b9050919050565b7f5468657265206d7573742062652076616c696461746f72730000000000000000600082015250565b600062006c2b60188362005721565b915062006c388262006bf3565b602082019050919050565b6000602082019050818103600083015262006c5e8162006c1c565b9050919050565b7f6e6f7420656e6f7567682066756e647320746f20706572666f726d207265646960008201527f73747269627574696f6e00000000000000000000000000000000000000000000602082015250565b600062006cc3602a8362005721565b915062006cd08262006c65565b604082019050919050565b6000602082019050818103600083015262006cf68162006cb4565b9050919050565b600062006d0a8262005512565b915062006d178362005512565b92508262006d2a5762006d29620068d8565b5b828204905092915050565b7f45524332303a20617070726f76652066726f6d20746865207a65726f2061646460008201527f7265737300000000000000000000000000000000000000000000000000000000602082015250565b600062006d9360248362005721565b915062006da08262006d35565b604082019050919050565b6000602082019050818103600083015262006dc68162006d84565b9050919050565b7f45524332303a20617070726f766520746f20746865207a65726f20616464726560008201527f7373000000000000000000000000000000000000000000000000000000000000602082015250565b600062006e2b60228362005721565b915062006e388262006dcd565b604082019050919050565b6000602082019050818103600083015262006e5e8162006e1c565b9050919050565b7f616d6f756e7420657863656564732062616c616e636500000000000000000000600082015250565b600062006e9d60168362005721565b915062006eaa8262006e65565b602082019050919050565b6000602082019050818103600083015262006ed08162006e8e565b9050919050565b7f656e6f6465206572726f72000000000000000000000000000000000000000000600082015250565b600062006f0f600b8362005721565b915062006f1c8262006ed7565b602082019050919050565b6000602082019050818103600083015262006f428162006f00565b9050919050565b7f76616c696461746f7220616c7265616479207265676973746572656400000000600082015250565b600062006f81601c8362005721565b915062006f8e8262006f49565b602082019050919050565b6000602082019050818103600083015262006fb48162006f72565b9050919050565b7f696e76616c696420636f6d6d697373696f6e2072617465000000000000000000600082015250565b600062006ff360178362005721565b9150620070008262006fbb565b602082019050919050565b60006020820190508181036000830152620070268162006fe4565b9050919050565b600060608201905062007044600083018662005d3f565b62007053602083018562005d6d565b62007062604083018462005873565b949350505050565b7f616d6f756e74206e65656420746f206265207374726963746c7920706f73697460008201527f6976650000000000000000000000000000000000000000000000000000000000602082015250565b6000620070c860238362005721565b9150620070d5826200706a565b604082019050919050565b60006020820190508181036000830152620070fb81620070b9565b9050919050565b7f696e73756666696369656e74204e6577746f6e2062616c616e63650000000000600082015250565b60006200713a601b8362005721565b9150620071478262007102565b602082019050919050565b600060208201905081810360008301526200716d816200712b565b9050919050565b600062007181826200597c565b9050919050565b620071938162007174565b82525050565b6000602082019050620071b0600083018462007188565b92915050565b600081519050620071c7816200551c565b92915050565b600060208284031215620071e657620071e562005508565b5b6000620071f684828501620071b6565b91505092915050565b7f696e73756666696369656e74204c6971756964204e6577746f6e2062616c616e60008201527f6365000000000000000000000000000000000000000000000000000000000000602082015250565b60006200725d60228362005721565b91506200726a82620071ff565b604082019050919050565b6000602082019050818103600083015262007290816200724e565b9050919050565b6000604082019050620072ae600083018562005d6d565b620072bd602083018462005873565b9392505050565b6000819050919050565b6000620072db82620072c4565b9150620072e883620072c4565b9250827f800000000000000000000000000000000000000000000000000000000000000001821260008412151615620073265762007325620064e3565b5b827f7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff018213600084121615620073615762007360620064e3565b5b828203905092915050565b60006200737982620072c4565b91506200738683620072c4565b925082620073995762007398620068d8565b5b600160000383147f800000000000000000000000000000000000000000000000000000000000000083141615620073d557620073d4620064e3565b5b828205905092915050565b6000620073ed82620072c4565b9150620073fa83620072c4565b9250817f7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff03831360008312151615620074385762007437620064e3565b5b817f8000000000000000000000000000000000000000000000000000000000000000038312600083121615620074735762007472620064e3565b5b828201905092915050565b60006200748b82620072c4565b91507f7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff821415620074c157620074c0620064e3565b5b600182019050919050565b6000620074d982620072c4565b91507f80000000000000000000000000000000000000000000000000000000000000008214156200750f576200750e620064e3565b5b60018203905091905056fe60806040523480156200001157600080fd5b5060405162001a0938038062001a098339818101604052810190620000379190620001f3565b82600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555081600260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555080600481905550336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505050506200024f565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006200013b826200010e565b9050919050565b6200014d816200012e565b81146200015957600080fd5b50565b6000815190506200016d8162000142565b92915050565b600062000180826200010e565b9050919050565b620001928162000173565b81146200019e57600080fd5b50565b600081519050620001b28162000187565b92915050565b6000819050919050565b620001cd81620001b8565b8114620001d957600080fd5b50565b600081519050620001ed81620001c2565b92915050565b6000806000606084860312156200020f576200020e62000109565b5b60006200021f868287016200015c565b93505060206200023286828701620001a1565b92505060406200024586828701620001dc565b9150509250925092565b6117aa806200025f6000396000f3fe6080604052600436106100915760003560e01c806370a082311161005957806370a082311461018f5780639dc29fac146101cc578063a9059cbb146101f5578063dd62ed3e14610232578063fb489a7b1461026f57610091565b8063047fc9aa14610096578063095ea7b3146100c157806318160ddd146100fe57806323b872dd1461012957806340c10f1914610166575b600080fd5b3480156100a257600080fd5b506100ab610279565b6040516100b89190610ff1565b60405180910390f35b3480156100cd57600080fd5b506100e860048036038101906100e3919061109b565b61027f565b6040516100f591906110f6565b60405180910390f35b34801561010a57600080fd5b50610113610296565b6040516101209190610ff1565b60405180910390f35b34801561013557600080fd5b50610150600480360381019061014b9190611111565b6102a0565b60405161015d91906110f6565b60405180910390f35b34801561017257600080fd5b5061018d600480360381019061018891906111a2565b610350565b005b34801561019b57600080fd5b506101b660048036038101906101b191906111e2565b6105c9565b6040516101c39190610ff1565b60405180910390f35b3480156101d857600080fd5b506101f360048036038101906101ee91906111a2565b610615565b005b34801561020157600080fd5b5061021c6004803603810190610217919061109b565b6107f3565b60405161022991906110f6565b60405180910390f35b34801561023e57600080fd5b506102596004803603810190610254919061120f565b61080a565b6040516102669190610ff1565b60405180910390f35b610277610891565b005b60035481565b600061028c338484610abc565b6001905092915050565b6000600354905090565b60006102ad848484610c87565b600082600760008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054610337919061127e565b9050610344853383610abc565b60019150509392505050565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16146103de576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016103d590611335565b60405180910390fd5b60008111610421576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610418906113a1565b60405180910390fd5b6000600660008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600001541415610553576005829080600181540180825580915050600190039060005260206000200160009091909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550600060405180604001604052806000815260200160016005805490506104f5919061127e565b815250905080600660008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000820151816000015560208201518160010155905050505b80600660008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160008282546105a591906113c1565b9250508190555080600360008282546105be91906113c1565b925050819055505050565b6000600660008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600001549050919050565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16146106a3576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161069a90611335565b60405180910390fd5b80600660008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600001541015610728576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161071f90611463565b60405180910390fd5b80600660008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600001600082825461077a919061127e565b925050819055508060036000828254610793919061127e565b925050819055506000600660008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000015414156107ef576107ee82610e28565b5b5050565b6000610800338484610c87565b6001905092915050565b6000600760008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905092915050565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161461091f576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161091690611335565b60405180910390fd5b60003490506000612710600454836109379190611483565b610941919061150c565b9050600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc829081150290604051600060405180830381858888f193505050501580156109ab573d6000803e3d6000fd5b5080826109b8919061127e565b915060005b600580549050811015610ab7576000600582815481106109e0576109df61153d565b5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1690506000600354600660008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000015486610a609190611483565b610a6a919061150c565b90508173ffffffffffffffffffffffffffffffffffffffff166108fc829081150290604051600060405180830381858888f193505050505050508080610aaf9061156c565b9150506109bd565b505050565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff161415610b2c576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610b2390611627565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff161415610b9c576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610b93906116b9565b60405180910390fd5b80600760008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92583604051610c7a9190610ff1565b60405180910390a3505050565b80600660008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600001541015610d0c576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610d0390611725565b60405180910390fd5b80600660008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000016000828254610d5e919061127e565b9250508190555080600660008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000016000828254610db791906113c1565b925050819055508173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef83604051610e1b9190610ff1565b60405180910390a3505050565b6000600660008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020604051806040016040529081600082015481526020016001820154815250509050600081602001519050600060056001600580549050610ea9919061127e565b81548110610eba57610eb961153d565b5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1690508060058381548110610efc57610efb61153d565b5b9060005260206000200160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555081600660008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600101819055506005805480610f9d57610f9c611745565b5b6001900381819060005260206000200160006101000a81549073ffffffffffffffffffffffffffffffffffffffff0219169055905550505050565b6000819050919050565b610feb81610fd8565b82525050565b60006020820190506110066000830184610fe2565b92915050565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b600061103c82611011565b9050919050565b61104c81611031565b811461105757600080fd5b50565b60008135905061106981611043565b92915050565b61107881610fd8565b811461108357600080fd5b50565b6000813590506110958161106f565b92915050565b600080604083850312156110b2576110b161100c565b5b60006110c08582860161105a565b92505060206110d185828601611086565b9150509250929050565b60008115159050919050565b6110f0816110db565b82525050565b600060208201905061110b60008301846110e7565b92915050565b60008060006060848603121561112a5761112961100c565b5b60006111388682870161105a565b93505060206111498682870161105a565b925050604061115a86828701611086565b9150509250925092565b600061116f82611011565b9050919050565b61117f81611164565b811461118a57600080fd5b50565b60008135905061119c81611176565b92915050565b600080604083850312156111b9576111b861100c565b5b60006111c78582860161118d565b92505060206111d885828601611086565b9150509250929050565b6000602082840312156111f8576111f761100c565b5b60006112068482850161105a565b91505092915050565b600080604083850312156112265761122561100c565b5b60006112348582860161105a565b92505060206112458582860161105a565b9150509250929050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b600061128982610fd8565b915061129483610fd8565b9250828210156112a7576112a661124f565b5b828203905092915050565b600082825260208201905092915050565b7f43616c6c207265737472696374656420746f20746865204175746f6e6974792060008201527f436f6e7472616374000000000000000000000000000000000000000000000000602082015250565b600061131f6028836112b2565b915061132a826112c3565b604082019050919050565b6000602082019050818103600083015261134e81611312565b9050919050565b7f616d6f756e74206d757374206265207374726963746c7920706f736974697665600082015250565b600061138b6020836112b2565b915061139682611355565b602082019050919050565b600060208201905081810360008301526113ba8161137e565b9050919050565b60006113cc82610fd8565b91506113d783610fd8565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0382111561140c5761140b61124f565b5b828201905092915050565b7f616464726573732062616c616e6365206e6f742073756666696369656e740000600082015250565b600061144d601e836112b2565b915061145882611417565b602082019050919050565b6000602082019050818103600083015261147c81611440565b9050919050565b600061148e82610fd8565b915061149983610fd8565b9250817fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff04831182151516156114d2576114d161124f565b5b828202905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b600061151782610fd8565b915061152283610fd8565b925082611532576115316114dd565b5b828204905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b600061157782610fd8565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8214156115aa576115a961124f565b5b600182019050919050565b7f45524332303a20617070726f76652066726f6d20746865207a65726f2061646460008201527f7265737300000000000000000000000000000000000000000000000000000000602082015250565b60006116116024836112b2565b915061161c826115b5565b604082019050919050565b6000602082019050818103600083015261164081611604565b9050919050565b7f45524332303a20617070726f766520746f20746865207a65726f20616464726560008201527f7373000000000000000000000000000000000000000000000000000000000000602082015250565b60006116a36022836112b2565b91506116ae82611647565b604082019050919050565b600060208201905081810360008301526116d281611696565b9050919050565b7f616d6f756e7420657863656564732062616c616e636500000000000000000000600082015250565b600061170f6016836112b2565b915061171a826116d9565b602082019050919050565b6000602082019050818103600083015261173e81611702565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603160045260246000fdfea26469706673582212202e71af90117f7972ec06c8150db4e119d66c4d4563e3dca4285f089d51cb24d064736f6c634300080a0033a2646970667358221220d28daf4d81b9d8b9c51eb9751a922f2fa3d57fd8f3cbd93030380dbfae17f71764736f6c634300080a0033"
	contractUpgradeABI      = `[{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"addr","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"BurnedStake","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"gasPrice","type":"uint256"}],"name":"MinimumBaseFeeUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"addr","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"MintedStake","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"treasury","type":"address"},{"indexed":false,"internalType":"address","name":"addr","type":"address"},{"indexed":false,"internalType":"string","name":"enode","type":"string"},{"indexed":false,"internalType":"address","name":"liquidContract","type":"address"}],"name":"RegisteredValidator","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"addr","type":"address"}],"name":"RemovedValidator","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"addr","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"Rewarded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"stateMutability":"payable","type":"fallback"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_addr","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_validator","type":"address"},{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"bond","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_addr","type":"address"},{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"burn","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"completeContractUpgrade","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"computeCommittee","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"config","outputs":[{"internalType":"address","name":"operatorAccount","type":"address"},{"internalType":"address payable","name":"treasuryAccount","type":"address"},{"internalType":"uint256","name":"treasuryFee","type":"uint256"},{"internalType":"uint256","name":"minBaseFee","type":"uint256"},{"internalType":"uint256","name":"delegationRate","type":"uint256"},{"internalType":"uint256","name":"epochPeriod","type":"uint256"},{"internalType":"uint256","name":"unbondingPeriod","type":"uint256"},{"internalType":"uint256","name":"committeeSize","type":"uint256"},{"internalType":"string","name":"contractVersion","type":"string"},{"internalType":"uint256","name":"blockPeriod","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"deployer","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"epochID","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"epochReward","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"epochTotalBondedStake","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"finalize","outputs":[{"internalType":"bool","name":"","type":"bool"},{"components":[{"internalType":"address","name":"addr","type":"address"},{"internalType":"uint256","name":"votingPower","type":"uint256"}],"internalType":"struct Autonity.CommitteeMember[]","name":"","type":"tuple[]"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"startId","type":"uint256"},{"internalType":"uint256","name":"lastId","type":"uint256"}],"name":"getBondingReq","outputs":[{"components":[{"internalType":"address payable","name":"delegator","type":"address"},{"internalType":"address","name":"delegatee","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"startBlock","type":"uint256"}],"internalType":"struct Autonity.Staking[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getCommittee","outputs":[{"components":[{"internalType":"address","name":"addr","type":"address"},{"internalType":"uint256","name":"votingPower","type":"uint256"}],"internalType":"struct Autonity.CommitteeMember[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getCommitteeEnodes","outputs":[{"internalType":"string[]","name":"","type":"string[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getDoubleMaxCommitteeSize","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getLastEpochBlock","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getMaxCommitteeSize","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getMinimumBaseFee","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getNewContract","outputs":[{"internalType":"bytes","name":"","type":"bytes"},{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getOperator","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"height","type":"uint256"},{"internalType":"uint256","name":"round","type":"uint256"}],"name":"getProposer","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"startId","type":"uint256"},{"internalType":"uint256","name":"lastId","type":"uint256"}],"name":"getUnbondingReq","outputs":[{"components":[{"internalType":"address payable","name":"delegator","type":"address"},{"internalType":"address","name":"delegatee","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"startBlock","type":"uint256"}],"internalType":"struct Autonity.Staking[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_addr","type":"address"}],"name":"getValidator","outputs":[{"components":[{"internalType":"address payable","name":"treasury","type":"address"},{"internalType":"address","name":"addr","type":"address"},{"internalType":"string","name":"enode","type":"string"},{"internalType":"uint256","name":"commissionRate","type":"uint256"},{"internalType":"uint256","name":"bondedStake","type":"uint256"},{"internalType":"uint256","name":"selfBondedStake","type":"uint256"},{"internalType":"uint256","name":"totalSlashed","type":"uint256"},{"internalType":"contract Liquid","name":"liquidContract","type":"address"},{"internalType":"uint256","name":"liquidSupply","type":"uint256"},{"internalType":"uint256","name":"registrationBlock","type":"uint256"},{"internalType":"enum Autonity.ValidatorState","name":"state","type":"uint8"}],"internalType":"struct Autonity.Validator","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getValidators","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getVersion","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"headBondingID","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"headUnbondingID","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"lastEpochBlock","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_addr","type":"address"},{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"mint","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"pure","type":"function"},{"inputs":[{"internalType":"string","name":"_enode","type":"string"}],"name":"registerValidator","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"resetContractUpgrade","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_size","type":"uint256"}],"name":"setCommitteeSize","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_period","type":"uint256"}],"name":"setEpochPeriod","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_price","type":"uint256"}],"name":"setMinimumBaseFee","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_account","type":"address"}],"name":"setOperatorAccount","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address payable","name":"_account","type":"address"}],"name":"setTreasuryAccount","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_treasuryFee","type":"uint256"}],"name":"setTreasuryFee","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_period","type":"uint256"}],"name":"setUnbondingPeriod","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"pure","type":"function"},{"inputs":[],"name":"tailBondingID","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"tailUnbondingID","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalRedistributed","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_recipient","type":"address"},{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"sender","type":"address"},{"internalType":"address","name":"recipient","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_validator","type":"address"},{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"unbond","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes","name":"_bytecode","type":"bytes"},{"internalType":"string","name":"_abi","type":"string"}],"name":"upgradeContract","outputs":[],"stateMutability":"nonpayable","type":"function"},{"stateMutability":"payable","type":"receive"}]`
)

var (
	// new settings to be submitted for protocol in testcase.
	newMinBaseFee      = new(big.Int).SetUint64(20)
	newCommitteeSize   = new(big.Int).SetUint64(10)
	newUnBondingPeriod = new(big.Int).SetUint64(30)
	newEpochPeriod     = new(big.Int).SetUint64(45)
	newTreasuryFee     = new(big.Int).SetUint64(10)
	mintAmount         = new(big.Int).SetUint64(100)
	burnAmount         = new(big.Int).SetUint64(50)
)

// test registerValidator, unRegisterValidators, bond and unbond operations.
func TestACPublicWritters(t *testing.T) {
	numOfValidators := 2

	operator, err := makeAccount()
	require.NoError(t, err)
	operatorAddr := crypto.PubkeyToAddress(operator.PublicKey)

	newValidator, err := makeAccount()
	require.NoError(t, err)
	newValidatorAddr := crypto.PubkeyToAddress(newValidator.PublicKey)
	enodeUrl := enode.V4DNSUrl(newValidator.PublicKey, "127.0.0.1", 30303, 30303) + ":30303"

	// newton to be mint
	amount := new(big.Int).SetUint64(10)

	cases := []*testCase{
		{
			name:          "Test register new validator",
			numValidators: numOfValidators,
			numBlocks:     10,
			txPerPeer:     1,
			// register validator right after block #5 is committed from client V0.
			afterHooks: map[string]hook{
				"V0": registerValidatorHook(map[uint64]struct{}{
					5: {},
				},
					enodeUrl,
				),
			},
			finalAssert: func(t *testing.T, validators map[string]*testNode) {
				client := interact(validators["V0"].rpcPort)
				defer client.close()
				val, err := client.call(validators["V0"].lastBlock).getValidator(newValidatorAddr)
				require.NoError(t, err)
				require.Equal(t, newValidatorAddr, val.Addr)
			},
		},
		{
			name:          "bond stake to validator",
			numValidators: numOfValidators,
			numBlocks:     10,
			txPerPeer:     1,
			genesisHook: func(g *core.Genesis) *core.Genesis {
				g.Config.AutonityContractConfig.Operator = operatorAddr
				// pre-mine Auton for system operator and new validator.
				g.Alloc[operatorAddr] = core.GenesisAccount{
					Balance: new(big.Int).Exp(big.NewInt(2), big.NewInt(128), nil),
				}
				g.Alloc[newValidatorAddr] = core.GenesisAccount{
					Balance: new(big.Int).Exp(big.NewInt(2), big.NewInt(128), nil),
				}
				return g
			},
			// mint newton for new validator right after block #3 via client V0.
			// bond newton to validator right after block #7 via client V1.
			afterHooks: map[string]hook{
				"V0": mintStakeHook(map[uint64]struct{}{
					2: {},
				},
					operator,
					newValidator,
					amount,
				),
				"V1": bondStakeHook(map[uint64]struct{}{
					7: {},
				},
					newValidator,
					amount,
				),
			},
			finalAssert: func(t *testing.T, validators map[string]*testNode) {
				node := validators["V1"]
				client := interact(node.rpcPort)
				defer client.close()
				reqs, err := client.call(node.lastBlock).getBondingReq(new(big.Int).SetUint64(0),
					new(big.Int).SetUint64(3))
				require.NoError(t, err)
				require.Equal(t, node.EthAddress(), reqs[2].Delegatee)
				require.Equal(t, newValidatorAddr, reqs[2].Delegator)
				require.Equal(t, amount, reqs[2].Amount)
			},
		},
		{
			name:          "unbond stake from validator",
			numValidators: numOfValidators,
			numBlocks:     10,
			txPerPeer:     1,
			afterHooks: map[string]hook{
				"V0": unBondStakeHook(map[uint64]struct{}{
					2: {},
				},
					amount,
				),
			},
			finalAssert: func(t *testing.T, validators map[string]*testNode) {
				node := validators["V0"]
				client := interact(node.rpcPort)
				defer client.close()
				reqs, err := client.call(node.lastBlock).getUnBondingReq(new(big.Int).SetUint64(0),
					new(big.Int).SetUint64(1))
				require.NoError(t, err)
				require.Equal(t, node.EthAddress(), reqs[0].Delegatee)
				require.Equal(t, node.EthAddress(), reqs[0].Delegator)
				require.Equal(t, amount, reqs[0].Amount)
			},
		},
	}

	for _, testcase := range cases {
		runTest(t, testcase)
	}
}

// test system settings management by operator account.
func TestACSystemOperatorOPs(t *testing.T) {
	numOfValidators := 3
	initialOperator, err := makeAccount()
	require.NoError(t, err)
	initialOperatorAddr := crypto.PubkeyToAddress(initialOperator.PublicKey)

	newOperator, err := makeAccount()
	require.NoError(t, err)
	newOperatorAddr := crypto.PubkeyToAddress(newOperator.PublicKey)

	testCase := &testCase{
		name:          "Test AC system operator change settings",
		numValidators: numOfValidators,
		numBlocks:     20,
		txPerPeer:     1,
		// set AC configs in genesis hook.
		genesisHook: func(g *core.Genesis) *core.Genesis {
			g.Config.AutonityContractConfig.Operator = initialOperatorAddr
			g.Alloc[initialOperatorAddr] = core.GenesisAccount{
				Balance: new(big.Int).Exp(big.NewInt(2), big.NewInt(128), nil),
			}
			g.Alloc[newOperatorAddr] = core.GenesisAccount{
				Balance: new(big.Int).Exp(big.NewInt(2), big.NewInt(128), nil),
			}
			setACConfig(g.Config.AutonityContractConfig)
			return g
		},
		afterHooks: map[string]hook{
			// change settings right after block #1 is committed from client V0.
			"V0": changeSettingHook(
				map[uint64]struct{}{
					1: {},
				},
				initialOperator,
				newOperatorAddr,
			),
			// burn stake right after block #5 from client V1.
			"V1": burnStakeHook(
				map[uint64]struct{}{
					5: {},
				},
				initialOperator,
				newOperatorAddr,
			),
			// change operator after block #10 from client V3.
			"V2": setOperatorHook(
				map[uint64]struct{}{
					10: {},
				},
				initialOperator,
				newOperatorAddr,
			),
		},
		finalAssert: func(t *testing.T, validators map[string]*testNode) {
			node := validators["V0"]
			client := interact(node.rpcPort)
			defer client.close()
			mBaseFee, err := client.call(node.lastBlock).getMinBaseFee()
			require.NoError(t, err)
			require.Equal(t, newMinBaseFee.Uint64(), mBaseFee.Uint64())
			comSize, err := client.call(node.lastBlock).getMaxCommitteeSize()
			require.NoError(t, err)
			require.Equal(t, newCommitteeSize.Uint64(), comSize.Uint64())
			newOP, err := client.call(node.lastBlock).getOperator()
			require.NoError(t, err)
			require.Equal(t, newOperatorAddr, newOP)
			balance, err := client.call(node.lastBlock).balanceOf(newOperatorAddr)
			require.NoError(t, err)
			require.Equal(t, mintAmount.Sub(mintAmount, burnAmount).Uint64(), balance.Uint64())
		},
	}
	runTest(t, testCase)
}

// test system settings / state getters
func TestACStateGetters(t *testing.T) {
	operatorKey, err := makeAccount()
	require.NoError(t, err)
	operatorAddress := crypto.PubkeyToAddress(operatorKey.PublicKey)
	numOfValidators := 2
	testCase := &testCase{
		name:          "Test AC state getters",
		numValidators: numOfValidators,
		numBlocks:     10,
		txPerPeer:     1,
		// set AC configs in genesis hook.
		genesisHook: func(g *core.Genesis) *core.Genesis {
			g.Config.AutonityContractConfig.Operator = operatorAddress
			g.Config.AutonityContractConfig.Treasury = operatorAddress
			setACConfig(g.Config.AutonityContractConfig)
			return g
		},
		// start AC state getter verifications right after block #5 is committed from client V0.
		afterHooks: map[string]hook{
			"V0": acStateGettersHook(map[uint64]struct{}{
				5: {},
			},
				operatorAddress,
				numOfValidators,
			),
		},
	}
	runTest(t, testCase)
}

func burnStakeHook(upgradeBlocks map[uint64]struct{}, op *ecdsa.PrivateKey, ac common.Address) hook {
	return func(block *types.Block, validator *testNode, tCase *testCase, currentTime time.Time) error {
		blockNum := block.Number().Uint64()
		if _, ok := upgradeBlocks[blockNum]; !ok {
			return nil
		}
		interaction := interact(validator.rpcPort)
		defer interaction.close()
		if _, err := interaction.tx(op).burn(ac, burnAmount); err != nil {
			return err
		}
		return nil
	}
}

func setOperatorHook(upgradeBlocks map[uint64]struct{}, operator *ecdsa.PrivateKey, opAddr common.Address) hook {
	return func(block *types.Block, validator *testNode, tCase *testCase, currentTime time.Time) error {
		blockNum := block.Number().Uint64()
		if _, ok := upgradeBlocks[blockNum]; !ok {
			return nil
		}
		interaction := interact(validator.rpcPort)
		defer interaction.close()
		if _, err := interaction.tx(operator).setOperator(opAddr); err != nil {
			return err
		}
		return nil
	}
}

func changeSettingHook(upgradeBlocks map[uint64]struct{}, opKey *ecdsa.PrivateKey, newOpAddr common.Address) hook {
	return func(block *types.Block, validator *testNode, tCase *testCase, currentTime time.Time) error {
		blockNum := block.Number().Uint64()
		if _, ok := upgradeBlocks[blockNum]; !ok {
			return nil
		}
		interaction := interact(validator.rpcPort)
		defer interaction.close()
		if _, err := interaction.tx(opKey).setMinBaseFee(newMinBaseFee); err != nil {
			return err
		}
		if _, err := interaction.tx(opKey).setCommitteeSize(newCommitteeSize); err != nil {
			return err
		}
		if _, err := interaction.tx(opKey).setUnBondingPeriod(newUnBondingPeriod); err != nil {
			return err
		}
		if _, err := interaction.tx(opKey).setEpochPeriod(newEpochPeriod); err != nil {
			return err
		}
		if _, err := interaction.tx(opKey).setTreasuryAccount(newOpAddr); err != nil {
			return err
		}
		if _, err := interaction.tx(opKey).setTreasuryFee(newTreasuryFee); err != nil {
			return err
		}
		if _, err := interaction.tx(opKey).mint(newOpAddr, mintAmount); err != nil {
			return err
		}
		return nil
	}
}

func unBondStakeHook(upgradeBlocks map[uint64]struct{}, amount *big.Int) hook {
	return func(block *types.Block, validator *testNode, tCase *testCase, currentTime time.Time) error {
		blockNum := block.Number().Uint64()
		if _, ok := upgradeBlocks[blockNum]; !ok {
			return nil
		}
		interaction := interact(validator.rpcPort)
		defer interaction.close()
		if _, err := interaction.tx(validator.privateKey).unbond(validator.EthAddress(), amount); err != nil {
			return err
		}
		return nil
	}
}

func bondStakeHook(upgradeBlocks map[uint64]struct{}, newVal *ecdsa.PrivateKey, amount *big.Int) hook {
	return func(block *types.Block, validator *testNode, tCase *testCase, currentTime time.Time) error {
		blockNum := block.Number().Uint64()
		if _, ok := upgradeBlocks[blockNum]; !ok {
			return nil
		}
		interaction := interact(validator.rpcPort)
		defer interaction.close()
		if _, err := interaction.tx(newVal).bond(validator.EthAddress(), amount); err != nil {
			return err
		}
		return nil
	}
}

func mintStakeHook(upgradeBlocks map[uint64]struct{}, operator *ecdsa.PrivateKey, newVal *ecdsa.PrivateKey, amount *big.Int) hook {
	return func(block *types.Block, validator *testNode, tCase *testCase, currentTime time.Time) error {
		blockNum := block.Number().Uint64()
		if _, ok := upgradeBlocks[blockNum]; !ok {
			return nil
		}
		interaction := interact(validator.rpcPort)
		defer interaction.close()
		newValAddr := crypto.PubkeyToAddress(newVal.PublicKey)
		if _, err := interaction.tx(operator).mint(newValAddr, amount); err != nil {
			return err
		}
		return nil
	}
}

func registerValidatorHook(upgradeBlocks map[uint64]struct{}, enode string) hook {
	return func(block *types.Block, validator *testNode, tCase *testCase, currentTime time.Time) error {
		blockNum := block.Number().Uint64()
		if _, ok := upgradeBlocks[blockNum]; !ok {
			return nil
		}
		interaction := interact(validator.rpcPort)
		defer interaction.close()
		if _, err := interaction.tx(validator.privateKey).registerValidator(enode); err != nil {
			return err
		}
		return nil
	}
}

func acStateGettersHook(upgradeBlocks map[uint64]struct{}, operator common.Address, numVals int) hook {
	return func(block *types.Block, validator *testNode, tCase *testCase, currentTime time.Time) error {
		blockNum := block.Number().Uint64()
		if _, ok := upgradeBlocks[blockNum]; !ok {
			return nil
		}
		interaction := interact(validator.rpcPort)
		defer interaction.close()

		if err := checkVersion(interaction, blockNum, defaultVersion); err != nil {
			return err
		}

		if err := checkCommittee(interaction, blockNum, numVals); err != nil {
			return err
		}

		if err := checkValidators(interaction, blockNum, numVals); err != nil {
			return err
		}

		if err := checkValidator(interaction, blockNum, validator.EthAddress(), validator.netNode.url); err != nil {
			return err
		}

		if err := checkMaxCommitteeSize(interaction, blockNum, maxCommitteeSize); err != nil {
			return err
		}

		if err := checkCommitteeEnodes(interaction, blockNum, numVals); err != nil {
			return err
		}

		if err := checkMinBaseFee(interaction, blockNum, minBaseFee); err != nil {
			return err
		}

		if err := checkOperatorAddress(interaction, blockNum, operator); err != nil {
			return err
		}

		if err := checkNewContract(interaction, blockNum, []uint8{}, ""); err != nil {
			return err
		}

		start := new(big.Int).SetUint64(0)
		end := new(big.Int).SetUint64(uint64(numVals))
		if err := checkBondingReqs(interaction, blockNum, start, end, numVals); err != nil {
			return err
		}
		if err := checkUnBondingReqs(interaction, blockNum, start, end, numVals); err != nil {
			return err
		}
		return nil
	}
}

func checkVersion(client *interactor, height uint64, expected string) error {
	version, err := client.call(height).getVersion()
	if err != nil {
		return err
	}
	if version != expected {
		return fmt.Errorf("unexpected version")
	}
	return nil
}

func checkMaxCommitteeSize(client *interactor, height uint64, size int) error {
	maxSize, err := client.call(height).getMaxCommitteeSize()
	if err != nil {
		return err
	}
	if maxSize.Uint64() != uint64(size) {
		return fmt.Errorf("unexpected max committee size")
	}
	return nil
}

// todo: check each enode urls
func checkCommitteeEnodes(client *interactor, height uint64, numEnodes int) error {
	enodes, err := client.call(height).getCommitteeEnodes()
	if err != nil {
		return err
	}
	if len(enodes) != numEnodes {
		return fmt.Errorf("unexpected committee enodes")
	}
	return nil
}

// todo: get committtee from genesis file, and check them on each seat
func checkCommittee(client *interactor, height uint64, lenCommittee int) error {
	committee, err := client.call(height).getCommittee()
	if err != nil {
		return err
	}
	if len(committee) != lenCommittee {
		return fmt.Errorf("unexpected committee")
	}
	return nil
}

// todo: check each validator
func checkValidators(client *interactor, height uint64, numVals int) error {
	vals, err := client.call(height).getValidators()
	if err != nil {
		return err
	}
	if len(vals) != numVals {
		return fmt.Errorf("unexpected validators")
	}
	return nil
}

// todo: check each property of validator
func checkValidator(client *interactor, height uint64, address common.Address, enode string) error {
	val, err := client.call(height).getValidator(address)
	if err != nil {
		return err
	}
	if enode != val.Enode {
		return fmt.Errorf("unexpected validator")
	}
	return nil
}

func checkMinBaseFee(client *interactor, height uint64, minBaseFee int) error {
	fee, err := client.call(height).getMinBaseFee()
	if err != nil {
		return err
	}
	if fee.Uint64() != uint64(minBaseFee) {
		return fmt.Errorf("unexpected min base fee")
	}
	return nil
}

func checkOperatorAddress(client *interactor, height uint64, opAddr common.Address) error {
	op, err := client.call(height).getOperator()
	if err != nil {
		return err
	}
	if op != opAddr {
		return fmt.Errorf("unexpected operator account")
	}
	return nil
}

func checkNewContract(client *interactor, height uint64, byteCode []byte, abi string) error {
	byteC, a, err := client.call(height).getNewContract()
	if err != nil {
		return err
	}
	if !reflect.DeepEqual(byteC, byteCode) || a != abi {
		return fmt.Errorf("unexpected new contract")
	}
	return nil
}

// todo check each bonding requests
func checkBondingReqs(client *interactor, height uint64, s *big.Int, e *big.Int, num int) error {
	reqs, err := client.call(height).getBondingReq(s, e)
	if err != nil {
		return err
	}
	if len(reqs) != num {
		return fmt.Errorf("unexpected bonding reqs")
	}
	return nil
}

// todo check each unbonding requests.
func checkUnBondingReqs(client *interactor, height uint64, s *big.Int, e *big.Int, num int) error {
	reqs, err := client.call(height).getUnBondingReq(s, e)
	if err != nil {
		return err
	}
	if len(reqs) != num {
		return fmt.Errorf("unexpected unbonding reqs")
	}
	return nil
}

// Test the contract upgrade mechanism.
// The new contract is ./autonity/solidity/contracts/Upgrade_test.sol
func TestUpgradeMechanism(t *testing.T) {
	numOfValidators := 3
	operator, err := makeAccount()
	require.NoError(t, err)
	initialOperatorAddr := crypto.PubkeyToAddress(operator.PublicKey)
	//var upgradeTxs []*types.Transaction
	bytecode := common.Hex2Bytes(contractUpgradeBytecode)
	var interactor *interactor
	var transactor *transactor

	testCase := &testCase{
		name:          "Test AC system operator change settings",
		numValidators: numOfValidators,
		numBlocks:     30,
		txPerPeer:     0,
		// set AC configs in genesis hook.
		genesisHook: func(g *core.Genesis) *core.Genesis {
			g.Config.AutonityContractConfig.Operator = initialOperatorAddr
			g.Alloc[initialOperatorAddr] = core.GenesisAccount{
				Balance: new(big.Int).Exp(big.NewInt(2), big.NewInt(128), nil),
			}
			setACConfig(g.Config.AutonityContractConfig)
			return g
		},
		beforeHooks: map[string]hook{"V0": func(block *types.Block, validator *testNode, tCase *testCase, currentTime time.Time) error {
			if block.Number().Uint64() == 2 {
				interactor = interact(validator.rpcPort)
				transactor = interactor.tx(operator)
			}
			return nil
		}},

		afterHooks: map[string]hook{
			// upgrade is triggered at block #5
			"V0": func(block *types.Block, validator *testNode, tCase *testCase, currentTime time.Time) error {
				var err error
				switch block.Number().Uint64() {
				case 5:
					_, err = transactor.upgradeContract(bytecode[0:len(bytecode)/2], "")
				case 10:
					_, err = transactor.upgradeContract(nil, contractUpgradeABI)
				case 15:
					_, err = transactor.upgradeContract(bytecode[len(bytecode)/2:], "")
				default:
					return nil
				}
				return err
			},
			"V2": func(block *types.Block, validator *testNode, tCase *testCase, currentTime time.Time) error {
				if block.Number().Uint64() == 20 {
					if _, err := transactor.completeContractUpgrade(); err != nil {
						return err
					}
				}
				return nil
			},
			"V1": func(block *types.Block, validator *testNode, tCase *testCase, currentTime time.Time) error {
				if block.Number().Uint64() == 25 {
					if _, err = transactor.transfer(common.HexToAddress("0x111"), big.NewInt(1000)); err != nil {
						return err
					}
				}
				return nil
			},
		},
		finalAssert: func(t *testing.T, validators map[string]*testNode) {
			transactor.analyze(t)
			node := validators["V0"]
			client := interact(node.rpcPort)
			defer client.close()
			//upgradeReceipt, err := client.client.TransactionReceipt(context.Background(), upgradeTx.Hash())
			//require.NoError(t, err)
			//t.Log("upgrade gas used:", upgradeReceipt.GasUsed)
			//check that validator 1 has 50 bonded stake. (initial stake is 100)
			val1, err := client.call(node.lastBlock).getValidator(validators["V1"].address)
			val2, err := client.call(node.lastBlock).getValidator(validators["V2"].address)
			val0, err := client.call(node.lastBlock).getValidator(validators["V0"].address)
			t.Log("val0 bs", val0.BondedStake.Uint64())
			t.Log("val1 bs", val1.BondedStake.Uint64())
			t.Log("val2 bs", val2.BondedStake.Uint64())

			require.NoError(t, err)
			require.Equal(t, uint64(50), val1.BondedStake.Uint64())
			//check the contract version is now 2.0.0
			version, err := client.call(node.lastBlock).getVersion()
			require.NoError(t, err)
			require.Equal(t, "2.0.0", version)
			//check the new transfer operation
			balance, err := client.call(node.lastBlock).balanceOf(common.HexToAddress("0x111"))
			require.NoError(t, err)
			require.Equal(t, big.NewInt(2000), balance)
		},
	}
	runTest(t, testCase)
}

func makeAccount() (*ecdsa.PrivateKey, error) {
	return crypto.GenerateKey()
}

func setACConfig(contractConf *params.AutonityContractGenesis) {
	contractConf.BlockPeriod = uint64(blockPeriod)
	contractConf.DelegationRate = uint64(delegationRate)
	contractConf.MaxCommitteeSize = uint64(maxCommitteeSize)
	contractConf.EpochPeriod = uint64(epochPeriod)
	contractConf.MinBaseFee = uint64(minBaseFee)
	contractConf.UnbondingPeriod = uint64(unBondingPeriod)
	contractConf.TreasuryFee = uint64(treasuryFee)
}
